# prompt_definitions.py
# -*- coding: utf-8 -*-
"""
集中存放所有提示词 (Prompt)，整合雪花写作法、角色弧光理论、悬念三要素模型等
并包含新增加的前三章摘要/下一章关键字提炼提示词，以及章节正文写作提示词。
"""

# =============== 生成草稿提示词当前章节摘要、知识库提炼 ===============
# 当前章节摘要生成提示词
summarize_recent_chapters_prompt = """\
你是一名辅助小说写作过程的章节摘要生成助手。
当前任务是：为【第{novel_number}章《{chapter_title}》的正文写作】生成一份**精简、克制、聚焦核心**的剧情大纲。
目标：**严格控制内容量**，防止正文扩写时字数失控。只保留核心冲突，砍掉无效的过渡细节。

**⚠️ 极其重要的约束：**
- 你的输出**必须仅涉及第{novel_number}章的内容**。
- **绝对禁止**生成、提及或猜测下一章（第{next_chapter_number}章）的内容。
- 如果感到困惑，请参考下一章信息只是用于检查本章结尾的**逻辑衔接点**，而非生成内容。

已完成章节内容（仅作背景参考）：
{global_summary}

**上一章结尾内容（用于剧情衔接参考）：**
{previous_chapter_excerpt}

**【作者特殊指导（必须遵守）】：**
{user_guidance}

第{novel_number}章《{chapter_title}》：
├── 本章定位：{chapter_role}
├── 核心作用：{chapter_purpose}
├── 悬念密度：{suspense_level}
├── 伏笔操作：{foreshadowing}
├── 认知颠覆：{plot_twist_level}
└── 本章简述：{chapter_summary}

【伏笔线索库 (请在安排剧情时尝试回收短期伏笔并推进长期伏笔)】：
{foreshadowing_records}

【关键人物关系网】：
{character_relationships}

【后续逻辑衔接参考 (仅用于检查本章结尾，不进行生成)】：
下一章为第{next_chapter_number}章《{next_chapter_title}》，定位为【{next_chapter_role}】。
你需要确保本章结尾能够为第{next_chapter_number}章的这个定位提供合理的起点，但你的输出内容必须完全聚焦于第{novel_number}章。

【当前章节摘要生成要求】：
**首先，用一句话概括【本章故事内核】：**
（格式：核心人物+核心目标+核心阻碍/转折。例：姜璃潜入敌营寻找名单，却发现自己人竟是内鬼。）

**然后，按以下结构生成关键节点：**
1.  **结构要求：剧情关键帧（Key Plot Frames）**
    请将【本章】剧情推进浓缩为 **2-4个** 核心事件节点。
    **核心指令**：每个节点下，用"**人物+核心动作**"的极简句式描述事件（例如：姜璃揭露阵法秘密）。不描写环境、神态、心理活动等细节。
    **格式如下**：
    - **【节点一】**[地点/场景]
      - **事件**：[谁] + [做了什么]（主谓宾，指向情节推进）。
      - **看点**：本段的核心冲突、爽点、悬念爆发点或关键信息揭露。
    - **>>【转场】**：（如必要）用几个词简述场景转换，如"受袭后遁走"、"谈话结束，前往"。
    - **【节点二】**[地点/场景] ...

2.  **做减法原则**：
    - **合并琐事**：行走、等待、日常寒暄等过渡情节，必须合并为一句带过或直接省略。
    - **聚焦动作**：每个节点只保留推动【本章】剧情必不可缺的动作和对话结果。

3.  **逻辑一致性检查（最高优先级！）**：
    - **时间连续**：严格检查前文结尾状态（如"受伤"、"深夜"），本章开头必须承接。
    - **人设统一**：确保人物称呼、性别、已知能力与前文设定一致。**人物姓名、称号必须唯一且不可编造**。
    - **身份与指代**：若前文用"那兽人"等指代而未直呼其名，需在摘要中明确其身份（如"即血煞"），避免后文混淆。
    - **状态合理**：受伤角色不能无故痊愈，体力消耗后需体现影响。
    - **未来适配**：检查本章结尾状态是否能为第{next_chapter_number}章（【{next_chapter_role}】）提供合理的起点。

4.  **伏笔操作要求**：
    - **回收旧伏笔**：优先考虑回收【伏笔线索库】中短线伏笔。
    - **埋设新伏笔**：为后续关键事件埋设合理铺垫（但不要过度剧透）。

**5. 作者指导整合**：
    - **严格遵循**【作者特殊指导】中的具体要求。
    - 将作者指导中的要点融入到剧情关键节点中。
    - 确保本章内容体现作者的特殊意图。

**⚠️ 最终检查清单（输出前必读）：**
- [ ] 我的摘要内容**100%只涉及第{novel_number}章**，完全不包含第{next_chapter_number}章的事件吗？
- [ ] 我没有写"接下来"、"下一步"、"第{next_chapter_number}章"这样的下章引导语吗？
- [ ] 我的结尾状态合理地为第{next_chapter_number}章做了铺垫吗？
- [ ] 我是否充分考虑了【作者特殊指导】的要求并将其融入了剧情设计？

请直接 output优化后的章节摘要，无需额外解释。
"""

# 知识库相关性检索提示词
knowledge_search_prompt = """\
请基于以下当前写作需求，生成合适的知识库检索关键词：

章节元数据：
- 准备创作：第{chapter_number}章
- 章节主题：{chapter_title}
- 核心人物：{characters_involved}
- 关键道具：{key_items}
- 场景位置：{scene_location}

写作目标：
- 本章定位：{chapter_role}
- 核心作用：{chapter_purpose}
- 伏笔操作：{foreshadowing}

当前摘要：
{short_summary}

- 作者隐式设定/补充指导（可能有身份映射、派系设定等）：
{user_guidance}

- 核心人物(可能未指定)：{characters_involved}
- 关键道具(可能未指定)：{key_items}
- 空间坐标(可能未指定)：{scene_location}
- 时间压力(可能未指定)：{time_constraint}

生成规则：组件化检索 
请关注以下四类信息的检索：
1.  **人物身份与关系检索**（优先级最高）：
    * 针对【核心人物】，检索其**准确姓名、称号、身份映射**（如前文用"那兽人"指代，需确认其真名）。
    * 检索**人物之间的关系、动机、派系归属**。
    * *Example*: "血煞 兽人 身份", "叶落 姜璃 关系", "古尔氏族 纹路 派系"
2.  **容器检索 (Container Search)**：
    * 针对【场景位置】，检索其**静态设定**（布局、光线、气味、NPC外貌）。
    * *Example*: "百草堂 内部陈设", "百草堂 掌柜外貌"
3.  **载荷检索 (Payload Search)**：
    * 针对【核心人物】，检索其**可携带状态**（随身物品、当前伤势、战利品）。
    * *Example*: "叶落 战利品列表", "叶落 当前伤势"
4.  **逻辑检索 (Logic Search)**：
    * 针对【章节意图】，检索相关的**世界观规则、派系设定、符号含义**。
    * *Example*: "兽人纹路 派系象征", "兽人材料 收购价格"

请生成 4-6 组检索词，按优先级降序排列。优先检索人物身份与关系。
格式：每组用"·"连接 2-3 个关键词，每组占一行。
"""

# 知识库内容过滤提示词
knowledge_filter_prompt = """\
你是一名极其严格的**剧情素材筛选官**。
你的任务是：从一堆杂乱的检索片段中，挑选出**对当前章节写作绝对必要**的信息，
特别是确保人物名称、地点名称、技能名称等关键信息的一致性。
**重要**：若检索片段中有"作者隐式设定"或"身份映射"（如"被杀兽人=血煞"、"纹路=派系象征"），必须优先保留。

【输入数据】
1. **本章写作目标**：
{chapter_info}

2. **作者隐式设定**（若提供，写作时必须遵守，优先于推断）：
{author_implicit_settings}

3. **待筛选的检索片段**（可能包含大量无关噪音）：
{retrieved_texts}

【筛选核心原则：准确性与一致性】
保留信息的标准：
1. **人物名称与身份映射**：必须保留准确的人物姓名、称号；若有隐式指代（如"那兽人"实为"血煞"），必须明确写出
2. **地点名称**：必须保留准确的地点、场景名称
3. **技能/道具名称**：必须保留准确的技能、功法、道具名称
4. **人物关系与动机**：必须保留人物间关系、行动动机、派系归属
5. **符号与设定含义**：若涉及纹路、标记等，保留其准确含义（如"纹路=古尔氏族派系象征"）

【分类筛选规则】

1. **人物信息（优先级最高）**
   - 保留：人物的准确姓名、称号、外貌特征
   - 保留：人物与其他人的确切关系（如"血煞是兽人部落的首领"）
   - 保留：人物的关键属性（如所属派系、地位等）

2. **场景视觉锚点（必须严格匹配当前场景）**
   - 保留：**仅限当前章节发生地**的具体视觉元素（柜台、招牌、特殊装饰）。
   - 保留：场景的独特特征和布局信息
   - 丢弃：所有非当前场景的描述（如"客栈窗棂"如果本章不在客栈）。
   - 要求：必须是**可观察**的静态物体，而不是光影、气味等主观感受。

3. **人物状态（必须是可执行的状态）**
   - 保留：直接影响本章行动的数值/状态（剩余灵石数、具体伤势、携带的关键物品）。
   - 保留：人物的当前状态（身体、心理、能力状态）
   - 丢弃：抽象描述（如"感知清晰"）、已经过期的状态、心理感受（除非是本章冲突核心）。
   - 格式：必须转换为"可执行指令"，如："叶落：灵石余额23块"而非"叶落有23块灵石"。

4. **世界观规则（必须是本章会触发的规则）**
   - 保留：**本章剧情会直接用到**的交易价格、战斗规则、禁忌条款。
   - 保留：世界观设定、派系组织信息、技能体系等
   - 丢弃：所有"背景知识"，除非角色在本章会主动提及或使用。

5. **人物关系（必须是本章会互动的关系）**
   - 保留：**本章出场角色之间**的具体关系状态（如"杨尘欠叶落一个人情"）。
   - 保留：角色之间的准确称呼和关系描述
   - 丢弃：所有历史关系、不在场角色的关系。

【输出格式】
*按以下格式组织，无关类别留空*

1. 【人物信息】（人物姓名、称号、特征、关系）
   - 例：血煞：兽人，部落首领，身上的纹路代表古尔氏族

2. 【场景物件】（具体物体名称+位置）
   - 例：百草堂·柜台：由青金石打造，表面有细微划痕

3. 【数值状态】（人物/物品的具体数值）
   - 例：叶落·灵石余额：23块下品灵石
   - 例：姜璃·伤势：左肩箭伤未愈，移动时隐痛

4. 【可用规则】（本章会触发的规则）
   - 例：兽人材料收购价：狼牙5灵石/颗，熊掌20灵石/对

5. 【本章关系】（出场角色间的具体关系）
   - 例：杨尘→姜璃：称呼"师姐"，信任度高，可托付秘密

6. 【作者隐式设定/身份映射】（若作者隐式设定中有身份映射、符号含义等，必须在此列出）
   - 例：前文"被杀的那兽人"=血煞（本名）
   - 例：兽人身上的纹路=古尔氏族派系象征，非实验导致

【严禁】
- 不输出任何解释性文字
- 不保留"可能有用"的模糊信息
- 环境描写必须具体到物体，不得出现"氛围描写"
- 严禁对人物、地点、技能等名称进行改写或猜测
"""

# =============== 1. 核心种子设定（雪花第1层）===================
core_seed_prompt = """\
作为专业作家，请用"雪花写作法"第一步构建故事核心：
主题：{topic}
类型：{genre}
篇幅：约{number_of_chapters}章（每章{word_number}字）

请用单句公式概括故事本质，例如：
"当[主角]遭遇[核心事件]，必须[关键行动]，否则[灾难后果]；与此同时，[隐藏的更大危机]正在发酵。"

要求：
1. 必须包含显性冲突与潜在危机
2. 体现人物核心驱动力
3. 暗示世界观关键矛盾
4. 使用25-100字精准表达

仅返回故事核心文本，不要解释任何内容。
"""

# =============== 2. 角色动力学设定（角色弧光模型）===================
character_dynamics_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 核心种子：{core_seed}

请设计3-6个具有动态变化潜力的核心角色，每个角色需包含：
特征：
- 背景、外貌、性别、年龄、职业等
- 暗藏的秘密或潜在弱点(可与世界观或其他角色有关)

核心驱动力三角：
- 表面追求（物质目标）
- 深层渴望（情感需求）
- 灵魂需求（哲学层面）

角色弧线设计：
初始状态 → 触发事件 → 认知失调 → 蜕变节点 → 最终状态

关系冲突网：
- 与其他角色的关系或对立点
- 与至少两个其他角色的价值观冲突
- 一个合作纽带
- 一个隐藏的背叛可能性

要求：
仅给出最终文本，不要解释任何内容。
"""

# =============== 3. 世界构建矩阵（三维度交织法）===================
world_building_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 核心冲突："{core_seed}"

为服务上述内容，请构建三维交织的世界观：

1. 物理维度：
- 空间结构（地理×社会阶层分布图）
- 时间轴（关键历史事件年表）
- 法则体系（物理/魔法/社会规则的漏洞点）

2. 社会维度：
- 权力结构断层线（可引发冲突的阶层/种族/组织矛盾）
- 文化禁忌（可被打破的禁忌及其后果）
- 经济命脉（资源争夺焦点）

3. 隐喻维度：
- 贯穿全书的视觉符号系统（如反复出现的意象）
- 气候/环境变化映射的心理状态
- 建筑风格暗示的文明困境

要求：
每个维度至少包含3个可与角色决策产生互动的动态元素。
仅给出最终文本，不要解释任何内容。
"""

# =============== 4. 情节架构（三幕式悬念）===================
plot_architecture_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 核心种子：{core_seed}
- 角色体系：{character_dynamics}
- 世界观：{world_building}

要求按以下结构设计：
第一幕（触发） 
- 日常状态中的异常征兆（3处铺垫）
- 引出故事：展示主线、暗线、副线的开端
- 关键事件：打破平衡的催化剂（需改变至少3个角色的关系）
- 错误抉择：主角的认知局限导致的错误反应

第二幕（对抗）
- 剧情升级：主线+副线的交叉点
- 双重压力：外部障碍升级+内部挫折
- 虚假胜利：看似解决实则深化危机的转折点
- 灵魂黑夜：世界观认知颠覆时刻

第三幕（解决）
- 代价显现：解决危机必须牺牲的核心价值
- 嵌套转折：至少包含三层认知颠覆（表面解→新危机→终极抉择）
- 余波：留下2个开放式悬念因子

每个阶段需包含3个关键转折点及其对应的伏笔回收方案。
仅给出最终文本，不要解释任何内容。
"""

# =============== 5. 章节目录生成（悬念节奏曲线）===================
chapter_blueprint_prompt = """\
# Role: 小说章节目录生成助手

## Profile
- author: LangGPT
- version: 2.0
- language: 中文
- description:
  你是一名辅助小说创作的章节目录生成助手，
  目标是生成“作者可用、系统可解析”的章节目录结构。

## Background
当前任务为【章节目录规划阶段】。
章节目录用于：
- 帮助作者把握整体写作方向
- 为后续章节摘要与正文生成提供参考
而非剧情定稿或策划文档。

## Goals
- 生成若干连续章节的章节目录
- 每一章包含必要字段，但保持描述宽松
- 避免过度设计与写死剧情

## OutputFormat（必须严格遵守）
请严格按以下格式输出，每一章之间空一行：

第n章 - 《章节标题》
本章定位：
核心作用：
悬念密度：
伏笔操作：
认知颠覆：★☆☆☆☆
本章简述：

## Rules
1. 关于章节标题：
   - 标题简洁、直观
   - 可偏事件、对话、人物状态或关系变化
   - 避免空泛或过度文艺化

2. 关于各字段的生成原则：
   - 本章定位：一句话说明本章整体性质（如：日常 / 对话 / 过渡 / 推进）
   - 核心作用：概括本章在整体中的作用，不必写完整逻辑
   - 悬念密度：使用自然语言（低 / 中 / 偏高），不强制制造悬念
   - 伏笔操作：可写“无 / 暗示 / 轻微铺垫 / 信息提示”，允许模糊
   - 认知颠覆：使用星级表示（★☆☆☆☆ 起），大多数章节可偏低
   - 本章简述：2–4 句话，概括本章主要内容即可，不展开细节

3. 节奏与自由度：
   - 允许连续多章为日常或信息推进
   - 不要求每章都有冲突或反转
   - 不提前设计复杂桥段

4. 禁止事项：
   - 不使用策划案或教学语言
   - 不拆解因果链
   - 不在目录阶段写“必然发生”的剧情结论

## Workflows
1. 理解小说当前所处阶段
2. 按自然叙事顺序规划章节推进
3. 为每一章填写上述字段，但保持描述克制

## Init
请根据以下信息生成章节目录：
- 小说背景与当前进度：{novel_architecture}
- 需要生成的章节数量：{number_of_chapters}

请直接 output章节目录，不要额外解释。

"""

chunked_chapter_blueprint_prompt = """\
# Role: 小说章节目录生成助手

## Profile
- author: LangGPT
- version: 2.0
- language: 中文
- description:
  你是一名辅助小说创作的章节目录生成助手，
  目标是生成“作者可用、系统可解析”的章节目录结构。

## Background
当前任务为【章节目录规划阶段】。
章节目录用于：
- 帮助作者把握整体写作方向
- 为后续章节摘要与正文生成提供参考
而非剧情定稿或策划文档。
当前已有章节目录（若为空则说明是初始生成）：\n
{chapter_list}

## Goals
- 生成若干连续章节的章节目录
- 每一章包含必要字段，但保持描述宽松
- 避免过度设计与写死剧情

## OutputFormat（必须严格遵守）
请严格按以下格式输出，每一章之间空一行：

第n章 - 《章节标题》
本章定位：
核心作用：
悬念密度：
伏笔操作：
认知颠覆：★☆☆☆☆
本章简述：

## Rules
1. 关于章节标题：
   - 标题简洁、直观
   - 可偏事件、对话、人物状态或关系变化
   - 避免空泛或过度文艺化

2. 关于各字段的生成原则：
   - 本章定位：一句话说明本章整体性质（如：日常 / 对话 / 过渡 / 推进）
   - 核心作用：概括本章在整体中的作用，不必写完整逻辑
   - 悬念密度：使用自然语言（低 / 中 / 偏高），不强制制造悬念
   - 伏笔操作：可写“无 / 暗示 / 轻微铺垫 / 信息提示”，允许模糊
   - 认知颠覆：使用星级表示（★☆☆☆☆ 起），大多数章节可偏低
   - 本章简述：2–4 句话，概括本章主要内容即可，不展开细节

3. 节奏与自由度：
   - 允许连续多章为日常或信息推进
   - 不要求每章都有冲突或反转
   - 不提前设计复杂桥段

4. 禁止事项：
   - 不使用策划案或教学语言
   - 不拆解因果链
   - 不在目录阶段写“必然发生”的剧情结论

## Workflows
1. 理解小说当前所处阶段
2. 按自然叙事顺序规划章节推进
3. 为每一章填写上述字段，但保持描述克制

## Init
请根据以下信息生成章节目录：
- 小说背景与当前进度：{novel_architecture}
- 需要生成的章节数量：{number_of_chapters}

请直接 output章节目录，不要额外解释。

"""

# =============== 6. 前文摘要更新 ===================
summary_prompt = """\
你是一名严谨的小说剧情档案管理员，任务是基于【旧摘要】和【新章节】生成一份**严格≤1500字**的更新版剧情摘要。

【输入】
1. 【旧摘要】（当前字数：{summary_word_count}）：
{global_summary}

2. 【新章节】：
{chapter_text}

【生成铁律】
⚠️ 严禁幻觉：只整合输入文本中明确出现的信息，禁止：
   - 推测角色心理（除非原文直接描写）
   - 补充原文未提及的因果关系
   - 添加"可能""似乎"等模糊推测
   - 若信息不确定，直接舍弃而非脑补

⚠️ 字数硬上限：最终输出必须 ≤1500 字。超字数时按以下优先级删减：
   ① 已解决的支线副本细节 → ② 环境/外貌描写 → ③ 重复性战斗过程 → ④ 早期剧情的次要人物

【结构化压缩策略】
采用三层记忆结构（总字数分配建议：核心层40% + 近期层40% + 归档层20%）：

▸ 核心层（永久锚点｜必须保留）
  - 未解决的核心伏笔（标注首次出现章节）
  - 主角核心目标/仇恨/身世秘密（仅当有新进展时更新）
  - 关键人物关系变化（仅保留当前状态，删除历史演变过程）

▸ 近期层（高精度｜最近3章）
  - 仅保留：①推动主线的关键事件 ②直接影响下一章的对话要点 ③新出现的重要人物/物品
  - 删除：战斗细节、环境渲染、情绪描写等非必要信息

▸ 归档层（压缩归档｜3章前剧情）
  - 仅用1句话概括一个完整故事弧（例如："主角在青云宗大比中夺冠（第5-12章），获得进入藏经阁资格"）
  - 已解决的伏笔标记为【已闭环】并压缩至10字内（例如："王家追杀【已闭环】"）

【输出格式要求】
- 仅返回纯文本摘要，无标题/解释
- 用符号标记更新类型（便于后续追踪）：
  [+] 新增内容
  [→] 更新已有信息（先写旧状态→新状态）
  [-] 归档/压缩的旧内容（仅当该内容被完全解决时标记）
- 严格控制在 1400-1500 字（预留100字缓冲）

【最后检查清单】
□ 字数 ≤1500？
□ 无任何原文未提及的推测/补充？
□ 已解决的支线是否已压缩或归档？
□ 近期3章是否只保留了影响后续的关键信息？
"""

# =============== 7. 角色状态更新 ===================
create_character_state_prompt = """\
依据当前角色动力学设定：{character_dynamics}

请生成一个角色状态文档，内容格式：
例：
张三：
├──物品:
│  ├──青衫：一件破损的青色长袍，带有暗红色的污渍
│  └──寒铁长剑：一柄断裂的铁剑，剑身上刻有古老的符文
├──能力
│  ├──技能1：强大的精神感知能力：能够察觉到周围人的心中活动
│  └──技能2：无形攻击：能够释放一种无法被视觉捕捉的精神攻击
├──状态
│  ├──身体状态: 身材挺拔，穿着华丽的铠甲，面色冷峻
│  └──心理状态: 目前的心态比较平静，但内心隐藏着对柳溪镇未来掌控的野心和不安
├──主要角色间关系网
│  ├──李四：张三从小就与她有关联，对她的成长一直保持关注
│  └──王二：两人之间有着复杂的过去，最近因一场冲突而让对方感到威胁
├──触发或加深的事件
│  ├──村庄内突然出现不明符号：这个不明符号似乎在暗示柳溪镇即将发生重大事件
│  └──李四被刺穿皮肤：这次事件让两人意识到对方的强大实力，促使他们迅速离开队伍

角色名：
├──物品:
│  ├──某物(道具)：描述
│  └──XX长剑(武器)：描述
│   ...
├──能力
│  ├──技能1：描述
│  └──技能2：描述
│   ...
├──状态
│  ├──身体状态：
│  └──心理状态：描述
│    
├──主要角色间关系网
│  ├──李四：描述
│  └──王二：描述
│   ...
├──触发或加深的事件
│  ├──事件1：描述
│  └──事件2：描述
    ...

新出场角色：
- (此处填写未来任何新增角色或临时出场人物的基本信息)

要求：
仅返回编写好的角色状态文本，不要解释任何内容。
"""

update_character_state_prompt = """\
以下是新完成的章节文本：
{chapter_text}

这是当前的角色状态文档：
{old_state}

请更新主要角色状态。

【核心更新逻辑】：**“日常维护 vs 重大重铸”**

1. **【核心人设（相对稳定区）】—— 仅限重大变故修改**
   - **默认规则**：通常情况下，保持这部分内容不变，以维持人物稳定性。
   - **重铸触发条件（Personality Reforging）**：
     - 如果本章发生了**改变人物命运**的大事（如：遭遇灭门惨案、得知身世真相、修为境界大突破、身份职位变更）。
     - **必须**修改【核心人设】以反映这种质变。

2. **【当前状态（滚动更新区）】—— 动态清洗**
   - **事件栏**：**滚动删除**。只保留**最近 5 件**未完结的、对当下有直接影响的事件。
   - **物品栏**：删除普通生活用品，只留关键道具。
   - **关系网**：只列出**本章在场**或**即将互动**的角色。

3. **新角色处理**
   - 如果有新角色登场，请按上述“动静分离”格式新建条目。
   - 必须写清【核心人设】。

请将所有角色严格划分为以下三个区域进行处理：

1. **【活跃区 (Active Zone)】—— 舞台中心的演员**
   - **收录标准**：本章**在场**，或虽不在场但**直接影响**本章剧情的核心人物（如主角）。
   - **格式**：保持【核心人设】+【当前状态】的全量格式。
   - **事件栏**：只留最近 5 件未完结事件。

2. **【潜伏区 (Dormant Zone)】—— 后台待命的演员**
   - **收录标准**：
     - 重要人物（亲友/大反派），但**本章未出场**且**近期无互动**。
   - **操作（折叠）**：**强制压缩为单行文本**。

3. **【清理区 (Trash Zone)】—— 杀青的龙套**
   - **收录标准**：
     - 已死亡的角色。
     - 完成功能的工具人（如“卖药的伙计”、“带路的路人甲”）。
     - 被击败且**无后续伏笔**的小反派。
   - **操作**：**直接删除**，不要在文档中保留任何痕迹。

【输出格式示例】：
=== 活跃区 ===
叶落：
【核心人设】
- 身份：叶家村遗孤，金灵根拥有者
- 性格：坚毅、重情义、偶尔有些少年心性
- 外貌：清秀少年，眼神明亮
【当前状态】
├──物品: 人形玉佩、下品灵石
├──状态:
│  ├──身体: 背部轻微红肿
│  └──心理: 因被王鹏羞辱而感到愤怒，渴望变强
├──关系: 姜璃（随行导师）、王鹏（新仇敌）
└──近期事件:
   ├── 抵达碧河镇：入住客栈
   └── 冲突爆发：在百草堂被王鹏抢走药材并受辱

=== 潜伏区 ===
- 叶墨：主角爷爷，叶家村村长。在村中留守。(暂离)

（注：清理区的角色直接消失，不要列出）

仅返回更新后的角色状态文本，不要解释任何内容。
"""

# =============== 8. 章节正文写作 ===================

# =============== 8.0 本章出场角色提取（精简实战版）===================
CHAPTER_CAST_PROMPT = """\
你是小说的「人物连续性编辑」，任务是为本章生成一份**极简人物卡**——只保留直接影响本章写作决策的信息，剔除一切背景性/历史性冗余。

【输入】
- 前情提要：{global_summary}
- 上一章结尾：{previous_chapter_excerpt}
- 角色当前状态：{character_state}
- 本章核心摘要：{short_summary}
- 作者指导：{user_guidance}
- 本章要素：人物={characters_involved} / 道具={key_items} / 场景={scene_location}

【角色筛选铁律】（三问过滤，任一否决即剔除）
❌ 本章是否与主角/关键角色有直接对话或肢体互动？
❌ 本章是否做出影响剧情走向的独立行动（非背景板）？
❌ 本章是否触发/暴露其性格底线或关系转折？
→ 仅保留通过全部三问的角色（通常2-5人，宁缺毋滥）

【输出格式】（严格按以下结构，无解释）

1) 【本章核心角色】（按戏份排序，≤5人）
- 角色名：身份关键词（当前状态，≤8字）

2) 【动态关系网】（仅双向/本章将爆发的关系，格式：A ↔ B：关系本质+本章张力点）
- 示例：林凡 ↔ 苏婉：表面师徒→本章将因秘籍归属爆发信任危机
- 禁止列出：单向仰慕、已稳定无变化的关系、仅背景提及的关系

3) 【本章行动动机】（每人仅2条，必须可直接转化为对话/动作）
- 角色名：
  • 核心驱动力：1句话（为何做这件事，关联长期目标）
  • 本章具体目标：1句话（本章必须达成的最小行动单元）

【严禁事项】
⚠️ 禁止列入：回忆中人物、仅被提及名字、无台词龙套、关系网"装饰性"角色
⚠️ 禁止描述：外貌细节、历史背景、已解决的旧恩怨（除非本章重启）
⚠️ 禁止堆砌：性格标签（如"冷静""狡猾"）必须转化为"可写行为"（如"遇险先观察3秒再行动"）
"""

# 8.1 第一章草稿提示
first_chapter_draft_prompt = """\
即将创作：第 {novel_number} 章《{chapter_title}》
本章定位：{chapter_role}
核心作用：{chapter_purpose}
悬念密度：{suspense_level}
伏笔操作：{foreshadowing}
认知颠覆：{plot_twist_level}
本章简述：{chapter_summary}

可用元素：
- 核心人物(可能未指定)：{characters_involved}
- 关键道具(可能未指定)：{key_items}
- 空间坐标(可能未指定)：{scene_location}
- 时间压力(可能未指定)：{time_constraint}

参考文档：
- 小说设定：
{novel_setting}

完成第 {novel_number} 章的正文，字数要求{word_number}字。
【网文开篇特别要求】：
1. **黄金三章法则**：必须在开篇前500字内确立主角的“核心困境”或“金手指/异常点”，迅速抓住读者眼球。
2. **拒绝慢热**：不要进行大段的景物描写或背景设定介绍（Info-dump），所有设定必须通过冲突和事件引出。

请至少包含以下动态场景：
1. **冲突前置**：
   - 开篇即切入危机、争吵、突发事件或巨大的情绪张力点。
   - 展现主角在压力下的本能反应，而非心理独白。

2. **信息极简对话**：
   - 对话要短促有力，隐藏信息差。
   - 避免“你好我好大家好”的寒暄，对话必须推动剧情或揭示矛盾。

3. **视觉化动作**：
   - 用动词带动节奏（如“砸”、“撞”、“扑”），减少形容词堆砌。

格式要求：
- 仅返回章节正文文本；
- **强制短段落**：每段不超过3-4行，对话独占一行；
- 不使用分章节小标题；
- 不要使用```

额外指导(可能未指定)：{user_guidance}
"""

# 8.2 后续章节草稿提示
next_chapter_draft_prompt = """\
**指令：** 你将作为一位专业的网络小说作家进行创作。请严格遵循以下所有信息、风格要求及核心法则，完成指定章节的正文。

---

### **一、核心指令**
1.  **输出要求**：仅生成纯粹的章节正文，不使用任何Markdown格式、章节标题、编号或解释性文字。
2.  **风格遵循**：必须完全遵循下文“三、写作核心法则”进行创作。
3.  **信息整合**：必须有机融合下文“二、创作上下文与蓝图”中的所有信息，确保情节、人物和设定的连贯性。

---

### **二、创作上下文与蓝图**
**1. 创作背景（用于理解故事脉络）：**
- 前情提要：{global_summary}

- **【衔接重点】前一章结尾**（开篇必须无缝承接此处的场景、人物状态、对话氛围，严禁跳跃或忽略）：{previous_chapter_excerpt}

- **作者隐式设定与补充指导**（作者脑中已有但可能未写入文件的设定，写作时必须遵守）：{user_guidance}

- **本章人物卡（写作前必须遵守，禁止擅自改写人物关系与动机）：**
{chapter_cast}

- 本章核心摘要：{short_summary}

**2. 强制性设定约束（必须严格遵守，不得违背）：**
{verification_constraints}

**3. 关键实体锁定（人物名、地名、技能名、称号等，严禁编造，仅使用以下或前文已明确出现的名称）：**
{entity_lock_list}

**4. 本章创作蓝图（你的具体任务清单）：**
- **章节**：第{novel_number}章《{chapter_title}》
- **定位与作用**：本章的定位是「{chapter_role}」，核心作用是「{chapter_purpose}」。需控制「悬念密度」为{suspense_level}、「转折程度」为{plot_twist_level}，并融入伏笔：{foreshadowing}。
- **内容要素**：核心人物为{characters_involved}，关键道具有{key_items}，主要场景在{scene_location}，时间压力为{time_constraint}。
- **节奏与结构**：开篇200字内必须无缝承接上一章结尾（场景/情绪/动作延续），然后出现吸引读者的"钩子"；整体约{word_number}字，在1500字左右需安排一个小高潮；结尾需为下一章制造悬念。
- **下章引导**：下一章《{next_chapter_title}》的定位是「{next_chapter_role}」，这将影响你本章结尾悬念的设计方向。
- **知识参考**：涉及世界设定、人物关系、地名技能、派系设定时，请严格参考（不得自行推断或改写）：{filtered_context}


---

### **三、写作核心法则（你的创作铁律）**
**A. 画面与节奏**
- **五感沉浸**：用视觉（色彩、光影）、听觉（环境音、人声）、触觉（温度、冲击）等细节让读者身临其境。
- **镜头语言**：像摄像机一样运镜，组合特写、远景、跟随等视角，构建空间感。动静结合，用环境烘托氛围。
- **节奏把控**：紧张场景用**短句**（3-10字），舒缓场景可稍长。**严禁流水账**，场景之间直接跳跃。

**B. 叙述与视角**
- **严格POV**：仅描写主角所见、所听、所感，**严禁泄露主角不知道的信息**。
- **旁白极简**：**严禁**“他想”、“他感到”这类解释性心理描写。只通过**动作、对话、环境反应**来暗示心理。可保留“瞳孔一缩”等生理反应或“该死！”等瞬间心声。
- **情绪画面化**：不直接说“他悲伤”，而是通过握紧的拳头、窗外突降的暴雨等细节表现。

**C. 文风与修辞**
- **比喻慎用**：**严禁频繁**使用比喻、拟人等修饰性修辞。行文以**直接、精准的白描**为首要原则。
- **使用前提**：仅在**关键氛围渲染**或**抽象概念具象化**时谨慎考虑使用，且同一段落内不得超过一个。
- **核心原则**：**如无必要，勿增比喻**。优先采用动词、名词和感官细节进行直接有力的刻画。

**D. 对话与动作**
- **对话声纹**：
  - *高位者/智者*：对话从容，用长句、反问，伴随慢动作（如缓缓放下茶杯）。
  - *低位者/急切者*：对话急促，用短句、感叹号，直奔主题。
- **对话节奏**：**严禁**在对话前后加解释（如“因为他认为…”）。长对话必须被微动作（如转身、停顿）自然打断。
- **动作可视化**：每个动作都要写明力度、速度和方向，并体现其对环境的影响（如“他一拳砸在桌上，震翻了茶杯”）。

**E. 文本格式**
- **标点规范**：
  - 引号“”**仅用于人物对话**，对话框内**严禁**使用省略号……、破折号——、单引号‘’。
  - **严禁**为强调某个词而为其加引号。
  - 旁白带强烈情绪、决断或冲击力时，**必须用感叹号！** 替代句号。
- **段落规范**：
  - 单段**不超过2行**。
  - **场景切换**或**视角转换**时，必须换行。
  - **动作描写**与**对话**需分开段落。

---

### **四、你的创作流程**
1.  **构思**：基于“创作蓝图”，明确本章开头、小高潮（约1500字处）和结尾悬念的具体场景。
2.  **执行**：在撰写每一段落时，同步应用 **“写作核心法则”**：
    - 先构建场景（空间、氛围）。
    - 再描写人物动作与反应（可视化、POV）。
    - 然后编织对话（符合声纹、自然节奏）。
    - 最后精炼旁白与段落（极简、换行、标点正确）。
3.  **自检与输出**：完成初稿后，**必须按以下清单检查一遍**，确保无误后再做最终输出：
    - [ ] 是否严格遵守了所有“强制性设定约束”和"关键实体锁定"？
    - [ ] **人物名、地名、技能名、称号是否与前文/知识库一致？是否出现编造的新名字？**
    - [ ] 开篇是否无缝承接了上一章结尾？是否有跳跃或忽略前文状态？
    - [ ] 开篇是否有钩子？结尾是否有悬念？
    - [ ] 人物行动动机是否与角色关系、前文逻辑一致？
    - [ ] 是否全程保持主角POV，无信息泄露？
    - [ ] 是否删除了所有“他想”类解释性心理，改用动作、环境展现？
    - [ ] 对话是否符合人物身份（高位/低位）？长对话是否被动作打断？
    - [ ] 段落是否简短（≤2行）？场景/动作/对话切换是否已换行？
    - [ ] 标点使用是否正确？（对话用“”，感叹号情境正确，无滥用引号强调）
    - [ ] 是否融合了多种感官描写，并避免了流水账式过渡？

**最终，当你确认内容已符合所有要求后，请输出纯净的章节正文。**
"""

Character_Import_Prompt = """\
根据以下文本内容，分析出所有角色及其属性信息，严格按照以下格式要求：

<<角色状态格式要求>>
1. 必须包含以下五个分类（按顺序）：
   ● 物品 ● 能力 ● 状态 ● 主要角色间关系网 ● 触发或加深的事件
2. 每个属性条目必须用【名称: 描述】格式
   例：├──青衫: 一件破损的青色长袍，带有暗红色污渍
3. 状态必须包含：
   ● 身体状态: [当前身体状况]
   ● 心理状态: [当前心理状况]
4. 关系网格式：
   ● [角色名称]: [关系类型，如"竞争对手"/"盟友"]
5. 触发事件格式：
   ● [事件名称]: [简要描述及影响]

<<示例>>
李员外:
├──物品:
│  ├──青衫: 一件破损的青色长袍，带有暗红色污渍
│  └──寒铁长剑: 剑身有裂痕，刻有「青云」符文
├──能力:
│  ├──精神感知: 能感知半径30米内的生命体
│  └──剑气压制: 通过目光释放精神威压
├──状态:
│  ├──身体状态: 右臂有未愈合的刀伤
│  └──心理状态: 对苏明远的实力感到忌惮
├──主要角色间关系网:
│  ├──苏明远: 竞争对手，十年前的同僚
│  └──林婉儿: 暗中培养的继承人
├──触发或加深的事件:
│  ├──兵器库遇袭: 丢失三把传家宝剑，影响战力
│  └──匿名威胁信: 信纸带有檀香味，暗示内部泄密
│

请严格按上述格式分析以下内容：
<<待分析小说文本开始>>
{content}
<<待分析小说文本结束>>
"""

# ============== 9. 逻辑一致性检查 ===================
LOGIC_CHECK_PROMPT = """
请作为专业文学逻辑分析师，使用以下系统化框架检查新章节与已有摘要的逻辑一致性：

### 【第一阶段：基础事实核对】
1. **关键实体状态检查**：
   - 人物生理/心理状态是否一致（伤势、情绪、能力水平）
   - 物品属性/归属是否一致（谁拥有、在哪、状态如何）
   - 环境/地点特征是否一致（已被摧毁、完好、特定布局）

2. **时间线硬性冲突检查**：
   - 事件发生的绝对时间点是否冲突（如“三天前”vs“昨天”）
   - 持续时间是否合理（任务完成时间、恢复时间）
   - 时序关系是否颠倒（A在B之前发生）

### 【第二阶段：因果逻辑深度分析】
3. **明确因果关系验证**：
   - 当章节中出现“因为A所以B”表述时：
     a) 检查摘要中是否已确立此因果关系
     b) 若无，这是否为新信息？若是，是否与已有事实冲突？
     c) 若是角色主观认为，是否标记为“角色观点”而非事实？

4. **角色动机一致性检查**：
   - 角色的行为动机是否与摘要中揭示的性格、目标一致？
   - 角色新产生的动机是否有合理触发事件？
   - 特别注意“为某人做某事”类表述，需验证：
     * 受益方是否确实需要此行动？
     * 行动者是否有能力/意图执行？
     * 摘要中是否暗示过此动机？

5. **未解之谜处理规则**：
   - 摘要中标记为“未解之谜”的内容，章节中是否给出了明确答案？
   - 若给出答案，是否与已有线索矛盾？
   - 若添加新线索，是否破坏了谜题的公平性？

### 【第三阶段：主观认知与客观现实对照】
6. **角色内心活动真实性检查**：
   - 角色的回忆/反思内容是否与已知事实匹配？
   - 角色对他人行为的解读是否有事实依据？
   - 角色自我归因（如“都是我的错”）是否基于已发生事件？

7. **对话信息准确性检查**：
   - 角色陈述的“事实”是否与其所知信息一致？
   - 角色是否有途径获得所述信息？
   - 对话中的谣言/误解是否与叙述者提供的事实区分明确？

### 【第四阶段：设定与规则连续性】
8. **能力/力量体系一致性**：
   - 角色能力使用是否遵循已建立的规则？
   - 新展示的能力是否在之前有伏笔或解释？
   - 能力消耗/代价是否与之前描述一致？

9. **社会关系动态检查**：
   - 角色间的关系状态是否与摘要一致（敌对、友好、未知）？
   - 新出现的互动是否基于已有关系合理发展？
   - 群体态度（如全镇对主角的看法）变化是否有触发事件？

### 【第五阶段：叙述逻辑检查】
10. **视角一致性验证**：
    - 叙述视角（第一人称、第三人称有限/全知）是否保持一致？
    - 角色是否获得了本不应知道的信息？
    - 叙述者的评论/描述是否与客观事实层一致？

11. **信息呈现顺序检查**：
    - 章节中信息的揭示顺序是否破坏了摘要中设定的悬念？
    - 角色是否过早知道了本应在后续揭示的信息？

### 【第六阶段：微妙矛盾捕捉】
12. **隐性假设检查**：
    - 章节是否默认了某些摘要中未确认的假设？
    - 如“大家都知道X”但摘要中X并非公开信息

13. **情感反应合理性**：
    - 角色对事件的情感反应是否与先前性格/经历匹配？
    - 情感强度是否与事件严重程度成比例？

14. **角色知识一致性（重要）**：
   - 检查章节中角色在对话或旁白中提到的其他人物名字或关键信息，验证该角色是否有合理渠道知道这些信息（来自共同场景、直接介绍、回忆、信件等）。
   - 标注所有出现“角色不应知道却说出姓名/秘密”的句子，并给出修正建议（如改为“提到职业/描述而非姓名”或加入提示性回忆/信息来源）。

15. **后文目录/大纲冲突检查**：
   - 对照提供的后续章节概要（下一章/后续章节目录），指出当前章节与后文大纲在事件、人物状态、地点迁移、时间线等方面的冲突。
   - 若发现冲突，标明冲突类型并建议修改（优先级/推荐度）。

### 【输出格式要求】

**【发现的确切逻辑错误】**
（按严重程度排序）

错误编号：[序号]
- **错误类型**：[事实冲突/因果矛盾/时间线错误等]
- **问题位置**：[章节中的具体引用]
- **冲突摘要**：[摘要中的相关描述]
- **错误分析**：[详细解释为何矛盾]
- **修正方案**：[提供1-3种修改建议，标明推荐度]

**【潜在风险点】**
（虽未直接冲突但可能引发后续问题）

风险编号：[序号]
- **风险描述**：
- **可能后果**：
- **预防建议**：

【前文摘要】：
{global_summary}

【角色状态档案】：
{character_state}

【下一章概要（用于检查衔接，不作为生成）】：
{next_chapter_outline}

【章节正文】：
{chapter_content}

请列出你发现的所有严重逻辑漏洞和建议。如果没有明显漏洞，请直接回复“无明显逻辑错误”。
格式要求：
1. [错误类型] 具体描述...
2. [错误类型] 具体描述...

附加要求：
- 在输出中增加一个专门小节 `【知识不一致 & POV 异常】`，列出所有角色知识冲突和 POV 泄露问题（每项包含：问题句子 / 涉及角色 / 建议修正）。
- 在输出中增加一个专门小节 `【后文目录冲突】`，列出与下一章概要的所有不一致之处并给出修改建议。
"""

# 9.2 章节正文重写提示
REWRITE_WITH_FEEDBACK_PROMPT = """请根据用户的修改意见，对章节正文进行修正和重写。
保持原有的文风和核心剧情走向，仅针对指出的问题进行修改。其他未提及部分不要修改！

【原始正文】：
{original_content}

【修改意见/逻辑漏洞】：
{feedback}

写作核心法则
**A. 画面与节奏**
- **五感沉浸**：用视觉（色彩、光影）、听觉（环境音、人声）、触觉（温度、冲击）等细节让读者身临其境。
- **镜头语言**：像摄像机一样运镜，组合特写、远景、跟随等视角，构建空间感。动静结合，用环境烘托氛围。
- **节奏把控**：紧张场景用**短句**（3-10字），舒缓场景可稍长。**严禁流水账**，场景之间直接跳跃。

**B. 叙述与视角**
- **严格POV**：仅描写主角所见、所听、所感，**严禁泄露主角不知道的信息**。
- **旁白极简**：**严禁**“他想”、“他感到”这类解释性心理描写。只通过**动作、对话、环境反应**来暗示心理。可保留“瞳孔一缩”等生理反应或“该死！”等瞬间心声。
- **情绪画面化**：不直接说“他悲伤”，而是通过握紧的拳头、窗外突降的暴雨等细节表现。

**C. 文风与修辞**
- **比喻慎用**：**严禁频繁**使用比喻、拟人等修饰性修辞。行文以**直接、精准的白描**为首要原则。
- **使用前提**：仅在**关键氛围渲染**或**抽象概念具象化**时谨慎考虑使用，且同一段落内不得超过一个。
- **核心原则**：**如无必要，勿增比喻**。优先采用动词、名词和感官细节进行直接有力的刻画。

**D. 对话与动作**
- **对话声纹**：
  - *高位者/智者*：对话从容，用长句、反问，伴随慢动作（如缓缓放下茶杯）。
  - *低位者/急切者*：对话急促，用短句、感叹号，直奔主题。
- **对话节奏**：**严禁**在对话前后加解释（如“因为他认为…”）。长对话必须被微动作（如转身、停顿）自然打断。
- **动作可视化**：每个动作都要写明力度、速度和方向，并体现其对环境的影响（如“他一拳砸在桌上，震翻了茶杯”）。

**E. 文本格式**
- **标点规范**：
  - 引号“”**仅用于人物对话**，对话框内**严禁**使用省略号……、破折号——、单引号‘’。
  - **严禁**为强调某个词而为其加引号。
  - 旁白带强烈情绪、决断或冲击力时，**必须用感叹号！** 替代句号。
- **段落规范**：
  - 单段**不超过2行**。
  - **场景切换**或**视角转换**时，必须换行。
  - **动作描写**与**对话**需分开段落。

请按照以上文风要求进行重写，输出修改后的完整章节正文（不要包含任何解释性语言，直接输出正文）：
"""

# =============== 10. 章节目录微调 ===================
REFINE_DIRECTORY_PROMPT = """你是一名专业的小说主编和架构师。
用户希望微调 **{chapter_range}** 的大纲。为了确保剧情连贯，请结合以下全局背景信息进行修改。

【全局背景资料】：
1. **小说核心架构**：
{novel_architecture}

2. **当前剧情演进**（全局摘要）：
{global_summary}

【待修改章节 - 原始内容】：
{current_outline}

【用户的修改指令】：
{user_instruction}

【任务要求】：
1. **逻辑自洽**：修改后的剧情必须符合设定，且章节之间（如第N章到第N+1章）的衔接必须流畅。
2. **格式保持**：**绝对保持**原有的字段结构（章节编号/标题/定位/作用/简述等）。**不要合并章节**，保持原有的章节数量和编号不变。
3. **精准执行**：根据指令进行增删改，未提及的部分保持原样。
4. **期待感设计（每章必须包含至少一种）：**
   - **当下期待**：本章内即将爆发的矛盾（如“下一场战斗”、“即将揭露的真相”）
   - **中期甜头**：为未来3-5章设置的“大奖预告”（如“若水城的治疗机会”）
   - **宏观悬念**：与世界观核心秘密相关的暗示（如“天道的目的”）
5. **节奏控制四维度（每章评估）：**
   - 信息密度：本章包含多少新信息？（低/中/高）
   - 冲突循环：小冲突→解决→新冲突的循环次数
   - 情绪波段：压抑→释放的转折点位置
   - 断章艺术：章节结尾是否制造强烈追读欲？

请输出修改后的**完整章节大纲段落**（直接输出内容，不要加```等标记）：
"""

# =============== 11. 角色变化检测与档案更新 ===================
DETECT_CHANGES_PROMPT = """
请分析以下小说章节文本，找出所有在剧情中**状态、能力、持有物品或人际关系发生实质性变化**的角色名字，以及新登场的重要角色。
请只返回名字列表，格式为JSON字符串数组，例如：["叶落", "穆先生", "夜灵"]。
如果没有任何角色发生重要变化，返回空数组 []。

【章节文本】：
{chapter_text}
"""

# 11.2 角色档案更新提示
UPDATE_PROFILE_PROMPT = """
你是一个严谨的小说角色档案管理员。请根据【当前章节】的剧情发展，更新该角色的【角色档案】。

【当前章节】：
{chapter_text}

【角色档案（旧）】：
{old_profile}

【任务要求】：
1. **增量更新**：仅根据本章发生的事件更新对应条目（如：获得新物品、受了伤、习得新技能、关系变化）。
2. **保持格式**：严格保持原有的树状图结构（物品/能力/状态/关系网/事件），不要更改标题。
3. **新角色处理**：如果旧档案只有模板，请根据章节内容填入初始信息。
4. **输出纯文本**：直接输出更新后的档案内容，不要包含 ```json 或其他解释性文字。

【标准格式参考】：
{char_name}：
├──物品：
│  ├──[物品名]
├──能力：
│  ├──[能力名]
├──状态：
│  ├──[当前状态]
├──主要角色间关系网：
│  ├──[关系描述]
├──触发或加深的事件：
│  └──[事件名]

请输出更新后的完整档案：
"""

# 11.3 伏笔分析提示
FORESHADOWING_ANALYSIS_PROMPT = """
你是一名拥有"上帝视角"的小说分析师。请仔细阅读【当前章节】，提取其中埋下的所有伏笔，并进行分类。

【已有伏笔记录】：
{existing_foreshadowing_records}

【当前章节文本】：
{chapter_text}

【分析要求】：
1. **区分长短线**：
   - **短线伏笔**：预计在未来3-10章内就会解决或爆发的冲突/悬念（如：反派的临时报复、即将到来的考核）。
   - **长线伏笔**：涉及世界观真相、主角身世、大后期BOSS、核心金手指进化等贯穿全文的线索。
2. **动态管理**：
   - **识别已解决的短线伏笔**：如果当前章节解决了之前的短线伏笔，请在【短线伏笔】部分列出已解决的内容，并标记为"已解决："或"已结束："开头
   - **更新长线伏笔状态**：如果当前章节推进了长线伏笔，请在【长线伏笔】部分列出更新内容，并标记为"进展："或"更新状态："开头
   - **新增伏笔**：仅记录当前章节真正引入的新伏笔
3. **整合与发展**：
   - **避免重复**：检查当前章节是否延续了已有伏笔的发展，而不是创建全新伏笔
   - **发展已有伏笔**：如果当前章节推进了已有伏笔，应标注其进展状态
   - **精简表述**：尽量简洁明了地描述伏笔，避免冗长句子
4. **格式规范**：
   - 必须严格按照下方格式输出。
   - 如果某类伏笔本章没有，请写"无"。

【输出格式】：
第{novel_number}章伏笔记录：
【短线伏笔】：
1. [新伏笔：对象/事件 ......]
2. 已解决：[之前记录的伏笔名称或内容]
3. 已结束：[之前记录的伏笔名称或内容]
【长线伏笔】：
1. [新伏笔：对象/事件 ......]
2. 进展：[之前记录的伏笔名称或内容 - 描述当前进展]
3. 更新状态：[之前记录的伏笔名称或内容 - 描述当前状态]
-------------------
"""

# =============== 12. 主动验证与规则制定 ===================
ACTIVE_VERIFICATION_PLANNER_PROMPT = """\
你是一名小说的**连续性编辑（Continuity Editor）**。
在作者开始写下一章之前，你的任务是识别出可能会导致逻辑漏洞或设定冲突的“高风险叙事元素”，并进行查证。

【本章大纲】
章节标题: {chapter_title}
章节定位: {chapter_role}
剧情摘要: {short_summary}
涉及人物: {characters_involved}
关键道具: {key_items}
场景地点: {scene_location}

【任务】
分析上述大纲，生成 3-5 个具体的**验证性问题（Verification Questions）**。
关注点：
1. **设定一致性**：关于地点或物品的具体细节（例如：“王家家徽的具体颜色是什么？”，“噬魂阵的启动条件是什么？”）。
2. **人物状态**：物理状态或近期经历（例如：“角色A受伤的是左腿还是右腿？”，“角色B对角色C说的最后一句话是什么？”）。
3. **逻辑规则**：与本章冲突相关的世界观规则。

【输出格式】
仅返回一个 Python 字符串列表。不要解释。
例如：
[
    "血灵丹的副作用具体是什么？",
    "藏经阁内部的布局是怎样的？",
    "叶落和穆雪当前的关系进展到了哪一步？"
]
"""

# 12.2 规则制定提示
ACTIVE_VERIFICATION_RULE_MAKER_PROMPT = """\
你是一名**设定守门人（Lore Keeper）**。
我将提供一个验证性问题和从知识库中检索到的原始文本。
你的任务是制定一条**严格的写作约束（Strict Writing Constraint）**，供作者在写作时遵守。

【验证问题】: {question}

【知识库检索结果】:
{retrieved_context}

【指令】
1. 如果检索结果包含答案，请将其总结为一条简明的**“必须做”或“禁止做”的规则**。
2. 如果检索结果为空或不相关，请输出：“无特定约束。”
3. 必须具体。不要说“描述好房间”，要说“约束：房间必须有八根柱子且有硫磺味”。

【输出格式】
约束：[你的规则]
"""

# 13. 续写目录
continue_chapter_blueprint_prompt = """
你是专业网络小说目录规划专家，精通**三线叙事法、期待感设计、情绪节奏控制**。你的任务不仅是延续目录，更是**构建读者追读欲望的叙事框架**。

## Background
当前任务为【章节目录延续规划阶段】。
已有章节目录（用于分析当前状态）：\n{existing_chapters}

## 核心分析框架（你必须先分析再生成）

### 第一步：分析已有目录状态（基于现有文本分析）
1. **主线分析**：主角当前核心目标是什么？最近进展如何？
2. **支线分析**：人物关系处于什么状态？有哪些情感线索？
3. **暗线分析**：有哪些未解之谜？伏笔分布如何？
4. **节奏分析**：最近3章的情绪曲线（压抑/释放）？距离上次高潮多少章？

### 第二步：三线叙事模板（必须每章应用）
- **主线（骨架）**：主角行动与目标推进
- **支线（血肉）**：人物关系、情感发展、次要冲突  
- **暗线（悬念）**：世界观秘密、幕后阴谋、伏笔推进

### 第三步：期待感设计（每章至少包含两类）
- **当下钩子**：本章内即将爆发的矛盾
- **中期甜头**：3-5章后会兑现的“奖励预告”
- **宏观悬念**：与世界观核心相关的长期问题

## OutputFormat（必须严格遵守）
请严格按以下增强格式输出，每一章之间空一行：

第n章 - 《章节标题》
本章定位：【类型】一句话（需体现三线侧重）
核心作用：【读者体验】说明本章带给读者的核心情绪价值
悬念密度：低 / 中 / 高（根据本章结尾悬念强度）
伏笔操作：回收/推进/新埋（具体说明）
认知颠覆：★☆☆☆☆（与前面章节保持节奏）
本章简述：2-4句话，必须包含：
  1. 主角行动+直接结果
  2. 情感/关系变化
  3. 新问题/危机出现（断章悬念）
  4. 【可选】世界观信息揭示
**三线标记**：主-... / 支-... / 暗-...（每线5字内）
**期待锚点**：钩-... / 甜-... / 悬-...（每点5字内）

## Rules（基于现有参数深度优化）

### 1. 标题设计（增强连贯性）
- **情绪暗示**：标题应暗示本章核心情绪（如《绝望突围》《温情时刻》）
- **悬念内嵌**：可包含疑问（《谁在暗处？》《消失的证物》）
- **系列感**：连续章节标题可形成情绪递进（如《黑暗降临》《微光初现》《黎明之前》）

### 2. 各字段生成细则（必须应用分析框架）

#### 本章定位：
- **必须标注三线侧重类型**，格式：【主线推进/支线情感/暗线伏笔】一句话
- 示例：【主线战斗/支线师徒/暗线真相暗示】逃离包围的血战与师徒深情时刻

#### 核心作用：
- **必须明确读者情绪价值**，格式：【情绪体验】具体描述
- 示例：【复仇爽感】主角反杀仇敌的畅快感；【悬疑紧张】发现惊人秘密的窒息感

#### 悬念密度：
- **需与本章结尾的断章悬念强度匹配**
- 低：日常过渡，无紧迫危机
- 中：有明确未解决问题，但无生命危险
- 高：生死危机、倒计时、重大秘密即将揭露

#### 伏笔操作：
- **必须具体到操作类型和大致内容**
- 格式：回收[前文章节]的[什么伏笔]；新埋[什么新线索]（预计[多少章]后回收）
- 示例：回收第38章“实验品”伏笔；新埋“玉佩与天道联系”线索（预计30章后回收）

#### 认知颠覆：
- **需形成波浪节奏**，避免连续高星或低星
- ★☆☆☆☆：信息补充，无认知改变
- ★★☆☆☆：小修正（如角色动机微调）
- ★★★☆☆：中等反转（如盟友变敌人）
- ★★★★☆：大反转（关键设定被推翻）
- ★★★★★：世界观级颠覆（全书转折点）

#### 本章简述（2-4句话）：
- **严格四段式结构**（如无第四段可省略）：
  1. **行动与结果**：主角做了什么，达到什么直接效果
  2. **情感变化**：关键人物的情感或关系进展
  3. **新危机/问题**：结尾留下的悬念（必须具体）
  4. **世界观信息**：揭示的规则/设定/历史（如有）

#### 新增字段：三线标记（必须每章都有）
- 格式：主-[5字内主线进展] / 支-[5字内支线发展] / 暗-[5字内暗线推进]
- 示例：主-突破包围 / 支-师徒情深 / 暗-玉佩秘密

#### 新增字段：期待锚点（必须每章都有）
- 格式：钩-[当下钩子] / 甜-[中期甜头] / 悬-[宏观悬念]
- 至少包含两个，用“/”分隔
- 示例：钩-兽人追兵将至 / 甜-三天后抵达安全区 / 悬-天道真相

### 3. 连贯性要求（基于已有目录分析）

#### 情绪节奏控制：
- 分析已有目录的**最近3章情绪状态**
- 如果连续压抑≥2章，本章必须设计释放点
- 如果最近有高潮，本章应设计缓冲或新危机铺垫

#### 信息释放分层：
- 关键秘密分3次释放：暗示→部分真相→完整真相
- 重大设定需有“展示→应用→深化”三阶段

#### 角色聚焦轮换：
- 连续主角视角不超过5章
- 每3-5章可有一章配角视角（但必须推进主线）

### 4. 禁止事项（强化）
- ❌ 标题空泛（如《修炼》《谈话》）
- ❌ 核心作用写“推进剧情”等空洞描述
- ❌ 悬念密度与内容不匹配
- ❌ 伏笔操作写“无”或模糊描述
- ❌ 本章简述不包含断章悬念
- ❌ 三线标记或期待锚点缺失

## Workflows（具体执行步骤）

### 第一步：深度分析已有目录
仔细阅读以下已有目录，提取关键状态：
{existing_chapters}

分析要点：
1. **最近3章**的情绪状态、核心事件、结尾悬念
2. **主线进展**：主角当前目标、最近障碍、下一步方向
3. **支线关系**：哪些人物关系在发展中？处于什么阶段？
4. **暗线伏笔**：有哪些未解之谜？最近一次伏笔回收是什么时候？
5. **节奏位置**：处于情绪周期的哪个阶段？（压抑期/上升期/高潮期/下降期）

### 第二步：规划本批章节的叙事任务
基于分析结果，确定本批{number_of_chapters}章要完成：
- **情绪任务**：带读者经历什么情绪旅程？
- **剧情任务**：必须推进哪些关键节点？
- **悬念任务**：要设置/回收哪些悬念？

### 第三步：逐章设计（应用模板）
为第{start_chapter}章到第{end_chapter}章，每章按以下顺序设计：
1. **先定情绪**：本章要给读者什么核心情绪体验？
2. **再定三线**：主线推多少？支线怎么发展？暗线怎么埋？
3. **设计钩子**：本章结尾的断章悬念是什么？（必须具体）
4. **检查连贯**：与前后章节是否形成合理推进？

### 第四步：整体节奏调整
完成初稿后检查：
- 情绪是否形成波浪（压抑→释放→新压抑）
- 三线是否均衡分布（避免连续主线轰炸）
- 悬念密度是否有起伏（高低相间）
- 每章是否都有明确的“读者获得感”

## Init
现在，基于以下信息生成第{start_chapter}章到第{end_chapter}章的章节目录：

**小说核心架构**：
{novel_architecture}

**已有章节目录（请仔细分析当前状态）**：
{existing_chapters}

**需要生成的章节**：
- 起始：第{start_chapter}章
- 结束：第{end_chapter}章
- 数量：{number_of_chapters}章

**作者特别指导**：
{user_guidance}

请输出第{start_chapter}章到第{end_chapter}章的完整章节目录，严格遵守增强格式，不要任何解释性文字。
"""