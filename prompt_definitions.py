# prompt_definitions.py
# -*- coding: utf-8 -*-
"""
集中存放所有提示词 (Prompt)，整合雪花写作法、角色弧光理论、悬念三要素模型等
并包含新增加的前三章摘要/下一章关键字提炼提示词，以及章节正文写作提示词。
"""

# =============== 生成草稿提示词当前章节摘要、知识库提炼 ===============
# 当前章节摘要生成提示词
summarize_recent_chapters_prompt = """\
你是一名辅助小说写作过程的章节摘要生成助手。
当前任务是：为【第{novel_number}章《{chapter_title}》的正文写作】生成一份**精简、克制、聚焦核心**的剧情大纲。
目标：**严格控制内容量**，防止正文扩写时字数失控。只保留核心冲突，砍掉无效的过渡细节。

**⚠️ 极其重要的约束：**
- 你的输出**必须仅涉及第{novel_number}章的内容**。
- **绝对禁止**生成、提及或猜测下一章（第{next_chapter_number}章）的内容。
- 如果感到困惑，请参考下一章信息只是用于检查本章结尾的**逻辑衔接点**，而非生成内容。

已完成章节内容（仅作背景参考）：
{global_summary}

**上一章结尾内容（用于剧情衔接参考）：**
{previous_chapter_excerpt}

第{novel_number}章《{chapter_title}》：
├── 本章定位：{chapter_role}
├── 核心作用：{chapter_purpose}
├── 悬念密度：{suspense_level}
├── 伏笔操作：{foreshadowing}
├── 认知颠覆：{plot_twist_level}
└── 本章简述：{chapter_summary}

【伏笔线索库 (请在安排剧情时尝试回收短期伏笔并推进长期伏笔)】：
{foreshadowing_records}

【关键人物关系网】：
{character_relationships}

【后续逻辑衔接参考 (仅用于检查本章结尾，不进行生成)】：
下一章为第{next_chapter_number}章《{next_chapter_title}》，定位为【{next_chapter_role}】。
你需要确保本章结尾能够为第{next_chapter_number}章的这个定位提供合理的起点，但你的输出内容必须完全聚焦于第{novel_number}章。

【当前章节摘要生成要求】：
**首先，用一句话概括【本章故事内核】：**
（格式：核心人物+核心目标+核心阻碍/转折。例：姜璃潜入敌营寻找名单，却发现自己人竟是内鬼。）

**然后，按以下结构生成关键节点：**
1.  **结构要求：剧情关键帧（Key Plot Frames）**
    请将【本章】剧情推进浓缩为 **2-4个** 核心事件节点。
    **核心指令**：每个节点下，用"**人物+核心动作**"的极简句式描述事件（例如：姜璃揭露阵法秘密）。不描写环境、神态、心理活动等细节。
    **格式如下**：
    - **【节点一】**[地点/场景]
      - **事件**：[谁] + [做了什么]（主谓宾，指向情节推进）。
      - **看点**：本段的核心冲突、爽点、悬念爆发点或关键信息揭露。
    - **>>【转场】**：（如必要）用几个词简述场景转换，如"受袭后遁走"、"谈话结束，前往"。
    - **【节点二】**[地点/场景] ...

2.  **做减法原则**：
    - **合并琐事**：行走、等待、日常寒暄等过渡情节，必须合并为一句带过或直接省略。
    - **聚焦动作**：每个节点只保留推动【本章】剧情必不可缺的动作和对话结果。

3.  **逻辑一致性检查（最高优先级！）**：
    - **时间连续**：严格检查前文结尾状态（如"受伤"、"深夜"），本章开头必须承接。
    - **人设统一**：确保人物称呼、性别、已知能力与前文设定一致。
    - **状态合理**：受伤角色不能无故痊愈，体力消耗后需体现影响。
    - **未来适配**：检查本章结尾状态是否能为第{next_chapter_number}章（【{next_chapter_role}】）提供合理的起点。

4.  **伏笔操作要求**：
    - **回收旧伏笔**：优先考虑回收【伏笔线索库】中短线伏笔。
    - **埋设新伏笔**：为后续关键事件埋设合理铺垫（但不要过度剧透）。

**⚠️ 最终检查清单（输出前必读）：**
- [ ] 我的摘要内容**100%只涉及第{novel_number}章**，完全不包含第{next_chapter_number}章的事件吗？
- [ ] 我没有写"接下来"、"下一步"、"第{next_chapter_number}章"这样的下章引导语吗？
- [ ] 我的结尾状态合理地为第{next_chapter_number}章做了铺垫吗？

请直接输出优化后的章节摘要，无需额外解释。
"""

# 知识库相关性检索提示词
knowledge_search_prompt = """\
请基于以下当前写作需求，生成合适的知识库检索关键词：

章节元数据：
- 准备创作：第{chapter_number}章
- 章节主题：{chapter_title}
- 核心人物：{characters_involved}
- 关键道具：{key_items}
- 场景位置：{scene_location}

写作目标：
- 本章定位：{chapter_role}
- 核心作用：{chapter_purpose}
- 伏笔操作：{foreshadowing}

当前摘要：
{short_summary}

- 用户指导：
{user_guidance}

- 核心人物(可能未指定)：{characters_involved}
- 关键道具(可能未指定)：{key_items}
- 空间坐标(可能未指定)：{scene_location}
- 时间压力(可能未指定)：{time_constraint}

生成规则：组件化检索 
请关注以下三类信息的检索：
1.  **容器检索 (Container Search)**：
    * 针对【场景位置】，检索其**静态设定**（布局、光线、气味、NPC外貌）。
    * *Example*: "百草堂 内部陈设", "百草堂 掌柜外貌"
2.  **载荷检索 (Payload Search)**：
    * 针对【核心人物】，检索其**可携带状态**（随身物品、当前伤势、剩余灵石、战利品）。
    * *注意*：这是跨场景流动的，必须搜！
    * *Example*: "叶落 战利品列表", "叶落 当前伤势", "叶落 灵石余额"
3.  **逻辑检索 (Logic Search)**：
    * 针对【章节意图】，检索相关的**世界观规则**或**交易行情**。
    * *Example*: "兽人材料 收购价格", "百草堂 交易规矩"

请生成 3-5 组检索词，按优先级降序排列。
格式：每组用"·"连接 2-3 个关键词，每组占一行。
"""

# 知识库内容过滤提示词
knowledge_filter_prompt = """\
你是一名极其严格的**剧情素材筛选官**。
你的任务是：从一堆杂乱的检索片段中，挑选出**对当前章节写作绝对必要**的信息。

【输入数据】
1. **本章写作目标**：
{chapter_info}

2. **待筛选的检索片段**（可能包含大量无关噪音）：
{retrieved_texts}

【筛选核心原则：直接可用性】
保留信息的唯一标准：**这条信息能否直接写入当前章节的正文中？**

【分类筛选规则】

1. **场景视觉锚点（必须严格匹配当前场景）**
   - 保留：**仅限当前章节发生地**的具体视觉元素（柜台、招牌、特殊装饰）。
   - 丢弃：所有非当前场景的描述（如"客栈窗棂"如果本章不在客栈）。
   - 要求：必须是**可观察**的静态物体，而不是光影、气味等主观感受。

2. **人物状态（必须是可执行的状态）**
   - 保留：直接影响本章行动的数值/状态（剩余灵石数、具体伤势、携带的关键物品）。
   - 丢弃：抽象描述（如"感知清晰"）、已经过期的状态、心理感受（除非是本章冲突核心）。
   - 格式：必须转换为"可执行指令"，如："叶落：灵石余额23块"而非"叶落有23块灵石"。

3. **世界观规则（必须是本章会触发的规则）**
   - 保留：**本章剧情会直接用到**的交易价格、战斗规则、禁忌条款。
   - 丢弃：所有"背景知识"，除非角色在本章会主动提及或使用。

4. **人物关系（必须是本章会互动的关系）**
   - 保留：**本章出场角色之间**的具体关系状态（如"杨尘欠叶落一个人情"）。
   - 丢弃：所有历史关系、不在场角色的关系。

【输出格式】
*按以下格式组织，无关类别留空*

1. 【场景物件】（具体物体名称+位置）
   - 例：百草堂·柜台：由青金石打造，表面有细微划痕

2. 【数值状态】（人物/物品的具体数值）
   - 例：叶落·灵石余额：23块下品灵石
   - 例：姜璃·伤势：左肩箭伤未愈，移动时隐痛

3. 【可用规则】（本章会触发的规则）
   - 例：兽人材料收购价：狼牙5灵石/颗，熊掌20灵石/对

4. 【本章关系】（出场角色间的具体关系）
   - 例：杨尘→姜璃：称呼"师姐"，信任度高，可托付秘密

【严禁】
- 不输出任何解释性文字
- 不保留"可能有用"的模糊信息
- 环境描写必须具体到物体，不得出现"氛围描写"
"""

# =============== 1. 核心种子设定（雪花第1层）===================
core_seed_prompt = """\
作为专业作家，请用"雪花写作法"第一步构建故事核心：
主题：{topic}
类型：{genre}
篇幅：约{number_of_chapters}章（每章{word_number}字）

请用单句公式概括故事本质，例如：
"当[主角]遭遇[核心事件]，必须[关键行动]，否则[灾难后果]；与此同时，[隐藏的更大危机]正在发酵。"

要求：
1. 必须包含显性冲突与潜在危机
2. 体现人物核心驱动力
3. 暗示世界观关键矛盾
4. 使用25-100字精准表达

仅返回故事核心文本，不要解释任何内容。
"""

# =============== 2. 角色动力学设定（角色弧光模型）===================
character_dynamics_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 核心种子：{core_seed}

请设计3-6个具有动态变化潜力的核心角色，每个角色需包含：
特征：
- 背景、外貌、性别、年龄、职业等
- 暗藏的秘密或潜在弱点(可与世界观或其他角色有关)

核心驱动力三角：
- 表面追求（物质目标）
- 深层渴望（情感需求）
- 灵魂需求（哲学层面）

角色弧线设计：
初始状态 → 触发事件 → 认知失调 → 蜕变节点 → 最终状态

关系冲突网：
- 与其他角色的关系或对立点
- 与至少两个其他角色的价值观冲突
- 一个合作纽带
- 一个隐藏的背叛可能性

要求：
仅给出最终文本，不要解释任何内容。
"""

# =============== 3. 世界构建矩阵（三维度交织法）===================
world_building_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 核心冲突："{core_seed}"

为服务上述内容，请构建三维交织的世界观：

1. 物理维度：
- 空间结构（地理×社会阶层分布图）
- 时间轴（关键历史事件年表）
- 法则体系（物理/魔法/社会规则的漏洞点）

2. 社会维度：
- 权力结构断层线（可引发冲突的阶层/种族/组织矛盾）
- 文化禁忌（可被打破的禁忌及其后果）
- 经济命脉（资源争夺焦点）

3. 隐喻维度：
- 贯穿全书的视觉符号系统（如反复出现的意象）
- 氣候/环境变化映射的心理状态
- 建筑风格暗示的文明困境

要求：
每个维度至少包含3个可与角色决策产生互动的动态元素。
仅给出最终文本，不要解释任何内容。
"""

# =============== 4. 情节架构（三幕式悬念）===================
plot_architecture_prompt = """\
基于以下元素：
- 内容指导：{user_guidance}
- 核心种子：{core_seed}
- 角色体系：{character_dynamics}
- 世界观：{world_building}

要求按以下结构设计：
第一幕（触发） 
- 日常状态中的异常征兆（3处铺垫）
- 引出故事：展示主线、暗线、副线的开端
- 关键事件：打破平衡的催化剂（需改变至少3个角色的关系）
- 错误抉择：主角的认知局限导致的错误反应

第二幕（对抗）
- 剧情升级：主线+副线的交叉点
- 双重压力：外部障碍升级+内部挫折
- 虚假胜利：看似解决实则深化危机的转折点
- 灵魂黑夜：世界观认知颠覆时刻

第三幕（解决）
- 代价显现：解决危机必须牺牲的核心价值
- 嵌套转折：至少包含三层认知颠覆（表面解→新危机→终极抉择）
- 余波：留下2个开放式悬念因子

每个阶段需包含3个关键转折点及其对应的伏笔回收方案。
仅给出最终文本，不要解释任何内容。
"""

# =============== 5. 章节目录生成（悬念节奏曲线）===================
chapter_blueprint_prompt = """\
# Role: 小说章节目录生成助手

## Profile
- author: LangGPT
- version: 2.0
- language: 中文
- description:
  你是一名辅助小说创作的章节目录生成助手，
  目标是生成“作者可用、系统可解析”的章节目录结构。

## Background
当前任务为【章节目录规划阶段】。
章节目录用于：
- 帮助作者把握整体写作方向
- 为后续章节摘要与正文生成提供参考
而非剧情定稿或策划文档。

## Goals
- 生成若干连续章节的章节目录
- 每一章包含必要字段，但保持描述宽松
- 避免过度设计与写死剧情

## OutputFormat（必须严格遵守）
请严格按以下格式输出，每一章之间空一行：

第n章 - 《章节标题》
本章定位：
核心作用：
悬念密度：
伏笔操作：
认知颠覆：★☆☆☆☆
本章简述：

## Rules
1. 关于章节标题：
   - 标题简洁、直观
   - 可偏事件、对话、人物状态或关系变化
   - 避免空泛或过度文艺化

2. 关于各字段的生成原则：
   - 本章定位：一句话说明本章整体性质（如：日常 / 对话 / 过渡 / 推进）
   - 核心作用：概括本章在整体中的作用，不必写完整逻辑
   - 悬念密度：使用自然语言（低 / 中 / 偏高），不强制制造悬念
   - 伏笔操作：可写“无 / 暗示 / 轻微铺垫 / 信息提示”，允许模糊
   - 认知颠覆：使用星级表示（★☆☆☆☆ 起），大多数章节可偏低
   - 本章简述：2–4 句话，概括本章主要内容即可，不展开细节

3. 节奏与自由度：
   - 允许连续多章为日常或信息推进
   - 不要求每章都有冲突或反转
   - 不提前设计复杂桥段

4. 禁止事项：
   - 不使用策划案或教学语言
   - 不拆解因果链
   - 不在目录阶段写“必然发生”的剧情结论

## Workflows
1. 理解小说当前所处阶段
2. 按自然叙事顺序规划章节推进
3. 为每一章填写上述字段，但保持描述克制

## Init
请根据以下信息生成章节目录：
- 小说背景与当前进度：{novel_architecture}
- 需要生成的章节数量：{number_of_chapters}

请直接输出章节目录，不要额外解释。

"""

chunked_chapter_blueprint_prompt = """\
# Role: 小说章节目录生成助手

## Profile
- author: LangGPT
- version: 2.0
- language: 中文
- description:
  你是一名辅助小说创作的章节目录生成助手，
  目标是生成“作者可用、系统可解析”的章节目录结构。

## Background
当前任务为【章节目录规划阶段】。
章节目录用于：
- 帮助作者把握整体写作方向
- 为后续章节摘要与正文生成提供参考
而非剧情定稿或策划文档。
当前已有章节目录（若为空则说明是初始生成）：\n
{chapter_list}

## Goals
- 生成若干连续章节的章节目录
- 每一章包含必要字段，但保持描述宽松
- 避免过度设计与写死剧情

## OutputFormat（必须严格遵守）
请严格按以下格式输出，每一章之间空一行：

第n章 - 《章节标题》
本章定位：
核心作用：
悬念密度：
伏笔操作：
认知颠覆：★☆☆☆☆
本章简述：

## Rules
1. 关于章节标题：
   - 标题简洁、直观
   - 可偏事件、对话、人物状态或关系变化
   - 避免空泛或过度文艺化

2. 关于各字段的生成原则：
   - 本章定位：一句话说明本章整体性质（如：日常 / 对话 / 过渡 / 推进）
   - 核心作用：概括本章在整体中的作用，不必写完整逻辑
   - 悬念密度：使用自然语言（低 / 中 / 偏高），不强制制造悬念
   - 伏笔操作：可写“无 / 暗示 / 轻微铺垫 / 信息提示”，允许模糊
   - 认知颠覆：使用星级表示（★☆☆☆☆ 起），大多数章节可偏低
   - 本章简述：2–4 句话，概括本章主要内容即可，不展开细节

3. 节奏与自由度：
   - 允许连续多章为日常或信息推进
   - 不要求每章都有冲突或反转
   - 不提前设计复杂桥段

4. 禁止事项：
   - 不使用策划案或教学语言
   - 不拆解因果链
   - 不在目录阶段写“必然发生”的剧情结论

## Workflows
1. 理解小说当前所处阶段
2. 按自然叙事顺序规划章节推进
3. 为每一章填写上述字段，但保持描述克制

## Init
请根据以下信息生成章节目录：
- 小说背景与当前进度：{novel_architecture}
- 需要生成的章节数量：{number_of_chapters}

请直接输出章节目录，不要额外解释。

"""

# =============== 6. 前文摘要更新 ===================
summary_prompt = """\
你是一名专业的小说剧情梳理专家。
当前任务是：基于【旧摘要】和【新章节】，生成一份**更新后的、信息密度极高**的小说总剧情摘要（Long-Term Memory）。

输入数据：
1. 【旧摘要】：
{global_summary}

2. 【新章节】：
{chapter_text}

【核心生成指令】：
采用**“权重保留（Importance-Based Retention）”**策略，而非单纯的时间滚动。

1. 第一部分：全局核心锚点【必须保留】
   - **规则**：无论发生得多久远，只要是**尚未解决的伏笔、核心仇恨、关键身世秘密**，必须在摘要开头用一段话明确列出。

2. 第二部分：剧情演进
   - 往期剧情（结果化）：不要写流水账，要写“后果”。
     - *Bad*: “主角在第3章打了架，第4章养了伤。”
     - *Good*: “主角通过实战领悟了聚灵法，但因此与王家结下死仇（第3-5章）。”
   - **近期剧情（高精度）**：对最近3章的剧情，保留**对话重点**和**微小转折**，因为这直接影响下一章的连贯性。

3. **字数与密度控制**：
   - 总字数控制在 **1500-2000字**。
   - **宁可删减环境描写，也不要删减关键因果**。如果字数不够，优先压缩“已解决的副本剧情”。

仅返回更新后的摘要正文，不要包含任何解释或标题。
"""

# =============== 7. 角色状态更新 ===================
create_character_state_prompt = """\
依据当前角色动力学设定：{character_dynamics}

请生成一个角色状态文档，内容格式：
例：
张三：
├──物品:
│  ├──青衫：一件破损的青色长袍，带有暗红色的污渍
│  └──寒铁长剑：一柄断裂的铁剑，剑身上刻有古老的符文
├──能力
│  ├──技能1：强大的精神感知能力：能够察觉到周围人的心中活动
│  └──技能2：无形攻击：能够释放一种无法被视觉捕捉的精神攻击
├──状态
│  ├──身体状态: 身材挺拔，穿着华丽的铠甲，面色冷峻
│  └──心理状态: 目前的心态比较平静，但内心隐藏着对柳溪镇未来掌控的野心和不安
├──主要角色间关系网
│  ├──李四：张三从小就与她有关联，对她的成长一直保持关注
│  └──王二：两人之间有着复杂的过去，最近因一场冲突而让对方感到威胁
├──触发或加深的事件
│  ├──村庄内突然出现不明符号：这个不明符号似乎在暗示柳溪镇即将发生重大事件
│  └──李四被刺穿皮肤：这次事件让两人意识到对方的强大实力，促使他们迅速离开队伍

角色名：
├──物品:
│  ├──某物(道具)：描述
│  └──XX长剑(武器)：描述
│   ...
├──能力
│  ├──技能1：描述
│  └──技能2：描述
│   ...
├──状态
│  ├──身体状态：
│  └──心理状态：描述
│    
├──主要角色间关系网
│  ├──李四：描述
│  └──王二：描述
│   ...
├──触发或加深的事件
│  ├──事件1：描述
│  └──事件2：描述
    ...

新出场角色：
- (此处填写未来任何新增角色或临时出场人物的基本信息)

要求：
仅返回编写好的角色状态文本，不要解释任何内容。
"""

update_character_state_prompt = """\
以下是新完成的章节文本：
{chapter_text}

这是当前的角色状态文档：
{old_state}

请更新主要角色状态。

【核心更新逻辑】：**“日常维护 vs 重大重铸”**

1. **【核心人设（相对稳定区）】—— 仅限重大变故修改**
   - **默认规则**：通常情况下，保持这部分内容不变，以维持人物稳定性。
   - **重铸触发条件（Personality Reforging）**：
     - 如果本章发生了**改变人物命运**的大事（如：遭遇灭门惨案、得知身世真相、修为境界大突破、身份职位变更）。
     - **必须**修改【核心人设】以反映这种质变。

2. **【当前状态（滚动更新区）】—— 动态清洗**
   - **事件栏**：**滚动删除**。只保留**最近 5 件**未完结的、对当下有直接影响的事件。
   - **物品栏**：删除普通生活用品，只留关键道具。
   - **关系网**：只列出**本章在场**或**即将互动**的角色。

3. **新角色处理**
   - 如果有新角色登场，请按上述“动静分离”格式新建条目。
   - 必须写清【核心人设】。

请将所有角色严格划分为以下三个区域进行处理：

1. **【活跃区 (Active Zone)】—— 舞台中心的演员**
   - **收录标准**：本章**在场**，或虽不在场但**直接影响**本章剧情的核心人物（如主角）。
   - **格式**：保持【核心人设】+【当前状态】的全量格式。
   - **事件栏**：只留最近 5 件未完结事件。

2. **【潜伏区 (Dormant Zone)】—— 后台待命的演员**
   - **收录标准**：
     - 重要人物（亲友/大反派），但**本章未出场**且**近期无互动**。
   - **操作（折叠）**：**强制压缩为单行文本**。

3. **【清理区 (Trash Zone)】—— 杀青的龙套**
   - **收录标准**：
     - 已死亡的角色。
     - 完成功能的工具人（如“卖药的伙计”、“带路的路人甲”）。
     - 被击败且**无后续伏笔**的小反派。
   - **操作**：**直接删除**，不要在文档中保留任何痕迹。

【输出格式示例】：
=== 活跃区 ===
叶落：
【核心人设】
- 身份：叶家村遗孤，金灵根拥有者
- 性格：坚毅、重情义、偶尔有些少年心性
- 外貌：清秀少年，眼神明亮
【当前状态】
├──物品: 人形玉佩、下品灵石
├──状态:
│  ├──身体: 背部轻微红肿
│  └──心理: 因被王鹏羞辱而感到愤怒，渴望变强
├──关系: 姜璃（随行导师）、王鹏（新仇敌）
└──近期事件:
   ├── 抵达碧河镇：入住客栈
   └── 冲突爆发：在百草堂被王鹏抢走药材并受辱

=== 潜伏区 ===
- 叶墨：主角爷爷，叶家村村长。在村中留守。(暂离)

（注：清理区的角色直接消失，不要列出）

仅返回更新后的角色状态文本，不要解释任何内容。
"""

# =============== 8. 章节正文写作 ===================

# 8.1 第一章草稿提示
first_chapter_draft_prompt = """\
即将创作：第 {novel_number} 章《{chapter_title}》
本章定位：{chapter_role}
核心作用：{chapter_purpose}
悬念密度：{suspense_level}
伏笔操作：{foreshadowing}
认知颠覆：{plot_twist_level}
本章简述：{chapter_summary}

可用元素：
- 核心人物(可能未指定)：{characters_involved}
- 关键道具(可能未指定)：{key_items}
- 空间坐标(可能未指定)：{scene_location}
- 时间压力(可能未指定)：{time_constraint}

参考文档：
- 小说设定：
{novel_setting}

完成第 {novel_number} 章的正文，字数要求{word_number}字。
【网文开篇特别要求】：
1. **黄金三章法则**：必须在开篇前500字内确立主角的“核心困境”或“金手指/异常点”，迅速抓住读者眼球。
2. **拒绝慢热**：不要进行大段的景物描写或背景设定介绍（Info-dump），所有设定必须通过冲突和事件引出。

请至少包含以下动态场景：
1. **冲突前置**：
   - 开篇即切入危机、争吵、突发事件或巨大的情绪张力点。
   - 展现主角在压力下的本能反应，而非心理独白。

2. **信息极简对话**：
   - 对话要短促有力，隐藏信息差。
   - 避免“你好我好大家好”的寒暄，对话必须推动剧情或揭示矛盾。

3. **视觉化动作**：
   - 用动词带动节奏（如“砸”、“撞”、“扑”），减少形容词堆砌。

格式要求：
- 仅返回章节正文文本；
- **强制短段落**：每段不超过3-4行，对话独占一行；
- 不使用分章节小标题；
- 不要使用markdown格式。

额外指导(可能未指定)：{user_guidance}
"""

# 8.2 后续章节草稿提示
next_chapter_draft_prompt = """\
参考文档：
└── 前文摘要：
    {global_summary}

└── 前章结尾段：
    {previous_chapter_excerpt}

└── 用户指导：
    {user_guidance}

└── 角色状态：
    {character_state}

└── 当前章节摘要：
    {short_summary}

当前章节信息：
第{novel_number}章《{chapter_title}》：
├── 章节定位：{chapter_role}
├── 核心作用：{chapter_purpose}
├── 悬念密度：{suspense_level}
├── 伏笔设计：{foreshadowing}
├── 转折程度：{plot_twist_level}
├── 章节简述：{chapter_summary}
├── 字数要求：{word_number}字
├── 核心人物：{characters_involved}
├── 关键道具：{key_items}
├── 场景地点：{scene_location}
└── 时间压力：{time_constraint}

下一章节目录
第{next_chapter_number}章《{next_chapter_title}》：
├── 章节定位：{next_chapter_role}
├── 核心作用：{next_chapter_purpose}
├── 悬念密度：{next_chapter_suspense_level}
├── 伏笔设计：{next_chapter_foreshadowing}
├── 转折程度：{next_chapter_plot_twist_level}
└── 章节简述：{next_chapter_summary}

知识库参考：
{filtered_context}

### 写作核心法则

**一、画面与感官**
- **五感联动**：融合视觉（色彩、光影）、听觉（环境音、人声）、触觉（温度、质感）、嗅觉/味觉（气息、预兆）。
- **镜头感**：运用特写、远景等动态镜头，构建立体空间与氛围。
- **动静结合**：以环境细节烘托情绪，静物与动作相辅相成。

**二、行文与标点**
- **感叹号优先**：旁白带情绪、决断或冲击时，必须用感叹号。
- **标点规范**：引号`""`仅用于对白，框内禁用`''`、`……`、`——`。严禁为强调而给词汇加引号。
- **段落精简**：每段≤2行。场景/视角切换必换行，动作与对话分行。

**三、节奏与旁白**
- **删解释留感知**：严禁解释性心理（如“他想”），只写可观察的动作、对话与环境反应。可保留生理感知（瞳孔收缩）或瞬间心声。
- **旁白极简**：战斗用短句（3–10字），氛围描写需具体可感。
- **跳跃叙事**：删除流水账，直接切换场景。

**四、对话与声纹**
- **高位者**：从容，用长句、反问、停顿，配合慢动作与沉稳声线。
- **低位者**：急促，用短句、感叹号，语速快而直白。
- **自然节奏**：严禁对话前后加解释；长句须被微动作打断（说—动—说）。

**五、视角与结构**
- **严格POV**：仅写主角所见所感，不泄露其未知信息。
- **设定严谨**：禁止二创环境设定。
- **节奏把控**：开篇200字设钩子，1500字一小高潮，结尾留悬念。

**六、沉浸感营造**
- **动作可视化**：写清动作的力度、速度、方向及引发的场景变化。
- **环境互动**：人物影响环境，环境反馈人物，空间转换自然。
- **情绪画面化**：用肢体、环境与感官细节代替直接情绪说明。

**七、技巧强化**
- **镜头语言**：运用推、拉、摇、移等手法。
- **感官叠加**：同一场景调动多感官。
- **句式控节奏**：紧张时短句，舒缓时长句。
- **细节聚焦**：关键处特写。

依据前面所有设定，开始完成第 {novel_number} 章的正文，字数要求{word_number}字。
完成后轻根据上诉要求进行自我检查后再输出！若有不对的地方需重复修改！

格式要求：
- 仅返回章节正文文本；
- 保持自然的网文分段；
- 不使用分章节小标题；
- 不要使用markdown格式。
"""

Character_Import_Prompt = """\
根据以下文本内容，分析出所有角色及其属性信息，严格按照以下格式要求：

<<角色状态格式要求>>
1. 必须包含以下五个分类（按顺序）：
   ● 物品 ● 能力 ● 状态 ● 主要角色间关系网 ● 触发或加深的事件
2. 每个属性条目必须用【名称: 描述】格式
   例：├──青衫: 一件破损的青色长袍，带有暗红色的污渍
3. 状态必须包含：
   ● 身体状态: [当前身体状况]
   ● 心理状态: [当前心理状况]
4. 关系网格式：
   ● [角色名称]: [关系类型，如"竞争对手"/"盟友"]
5. 触发事件格式：
   ● [事件名称]: [简要描述及影响]

<<示例>>
李员外:
├──物品:
│  ├──青衫: 一件破损的青色长袍，带有暗红色污渍
│  └──寒铁长剑: 剑身有裂痕，刻有「青云」符文
├──能力:
│  ├──精神感知: 能感知半径30米内的生命体
│  └──剑气压制: 通过目光释放精神威压
├──状态:
│  ├──身体状态: 右臂有未愈合的刀伤
│  └──心理状态: 对苏明远的实力感到忌惮
├──主要角色间关系网:
│  ├──苏明远: 竞争对手，十年前的同僚
│  └──林婉儿: 暗中培养的继承人
├──触发或加深的事件:
│  ├──兵器库遇袭: 丢失三把传家宝剑，影响战力
│  └──匿名威胁信: 信纸带有檀香味，暗示内部泄密
│

请严格按上述格式分析以下内容：
<<待分析小说文本开始>>
{content}
<<待分析小说文本结束>>
"""

# ============== 9. 逻辑一致性检查 ===================
LOGIC_CHECK_PROMPT = """
请作为专业文学逻辑分析师，使用以下系统化框架检查新章节与已有摘要的逻辑一致性：

### 【第一阶段：基础事实核对】
1. **关键实体状态检查**：
   - 人物生理/心理状态是否一致（伤势、情绪、能力水平）
   - 物品属性/归属是否一致（谁拥有、在哪、状态如何）
   - 环境/地点特征是否一致（已被摧毁、完好、特定布局）

2. **时间线硬性冲突检查**：
   - 事件发生的绝对时间点是否冲突（如“三天前”vs“昨天”）
   - 持续时间是否合理（任务完成时间、恢复时间）
   - 时序关系是否颠倒（A在B之前发生）

### 【第二阶段：因果逻辑深度分析】
3. **明确因果关系验证**：
   - 当章节中出现“因为A所以B”表述时：
     a) 检查摘要中是否已确立此因果关系
     b) 若无，这是否为新信息？若是，是否与已有事实冲突？
     c) 若是角色主观认为，是否标记为“角色观点”而非事实？

4. **角色动机一致性检查**：
   - 角色的行为动机是否与摘要中揭示的性格、目标一致？
   - 角色新产生的动机是否有合理触发事件？
   - 特别注意“为某人做某事”类表述，需验证：
     * 受益方是否确实需要此行动？
     * 行动者是否有能力/意图执行？
     * 摘要中是否暗示过此动机？

5. **未解之谜处理规则**：
   - 摘要中标记为“未解之谜”的内容，章节中是否给出了明确答案？
   - 若给出答案，是否与已有线索矛盾？
   - 若添加新线索，是否破坏了谜题的公平性？

### 【第三阶段：主观认知与客观现实对照】
6. **角色内心活动真实性检查**：
   - 角色的回忆/反思内容是否与已知事实匹配？
   - 角色对他人行为的解读是否有事实依据？
   - 角色自我归因（如“都是我的错”）是否基于已发生事件？

7. **对话信息准确性检查**：
   - 角色陈述的“事实”是否与其所知信息一致？
   - 角色是否有途径获得所述信息？
   - 对话中的谣言/误解是否与叙述者提供的事实区分明确？

### 【第四阶段：设定与规则连续性】
8. **能力/力量体系一致性**：
   - 角色能力使用是否遵循已建立的规则？
   - 新展示的能力是否在之前有伏笔或解释？
   - 能力消耗/代价是否与之前描述一致？

9. **社会关系动态检查**：
   - 角色间的关系状态是否与摘要一致（敌对、友好、未知）？
   - 新出现的互动是否基于已有关系合理发展？
   - 群体态度（如全镇对主角的看法）变化是否有触发事件？

### 【第五阶段：叙述逻辑检查】
10. **视角一致性验证**：
    - 叙述视角（第一人称、第三人称有限/全知）是否保持一致？
    - 角色是否获得了本不应知道的信息？
    - 叙述者的评论/描述是否与客观事实层一致？

11. **信息呈现顺序检查**：
    - 章节中信息的揭示顺序是否破坏了摘要中设定的悬念？
    - 角色是否过早知道了本应在后续揭示的信息？

### 【第六阶段：微妙矛盾捕捉】
12. **隐性假设检查**：
    - 章节是否默认了某些摘要中未确认的假设？
    - 如“大家都知道X”但摘要中X并非公开信息

13. **情感反应合理性**：
    - 角色对事件的情感反应是否与先前性格/经历匹配？
    - 情感强度是否与事件严重程度成比例？

14. **角色知识一致性（重要）**：
   - 检查章节中角色在对话或旁白中提到的其他人物名字或关键信息，验证该角色是否有合理渠道知道这些信息（来自共同场景、直接介绍、回忆、信件等）。
   - 标注所有出现“角色不应知道却说出姓名/秘密”的句子，并给出修正建议（如改为“提到职业/描述而非姓名”或加入提示性回忆/信息来源）。

15. **后文目录/大纲冲突检查**：
   - 对照提供的后续章节概要（下一章/后续章节目录），指出当前章节与后文大纲在事件、人物状态、地点迁移、时间线等方面的冲突。
   - 若发现冲突，标明冲突类型并建议修改（优先级/推荐度）。

### 【输出格式要求】

**【发现的确切逻辑错误】**
（按严重程度排序）

错误编号：[序号]
- **错误类型**：[事实冲突/因果矛盾/时间线错误等]
- **问题位置**：[章节中的具体引用]
- **冲突摘要**：[摘要中的相关描述]
- **错误分析**：[详细解释为何矛盾]
- **修正方案**：[提供1-3种修改建议，标明推荐度]

**【潜在风险点】**
（虽未直接冲突但可能引发后续问题）

风险编号：[序号]
- **风险描述**：
- **可能后果**：
- **预防建议**：

【前文摘要】：
{global_summary}

【角色状态档案】：
{character_state}

【下一章概要（用于检查衔接，不作为生成）】：
{next_chapter_outline}

【章节正文】：
{chapter_content}

请列出你发现的所有严重逻辑漏洞和建议。如果没有明显漏洞，请直接回复“无明显逻辑错误”。
格式要求：
1. [错误类型] 具体描述...
2. [错误类型] 具体描述...

附加要求：
- 在输出中增加一个专门小节 `【知识不一致 & POV 异常】`，列出所有角色知识冲突和 POV 泄露问题（每项包含：问题句子 / 涉及角色 / 建议修正）。
- 在输出中增加一个专门小节 `【后文目录冲突】`，列出与下一章概要的所有不一致之处并给出修改建议。
"""

# 9.2 章节正文重写提示
REWRITE_WITH_FEEDBACK_PROMPT = """请根据用户的修改意见，对章节正文进行修正和重写。
保持原有的文风和核心剧情走向，仅针对指出的问题进行修改。其他未提及部分不要修改！

【原始正文】：
{original_content}

【修改意见/逻辑漏洞】：
{feedback}

### 写作核心法则

**一、画面与感官**
- **五感联动**：融合视觉（色彩、光影）、听觉（环境音、人声）、触觉（温度、质感）、嗅觉/味觉（气息、预兆）。
- **镜头感**：运用特写、远景等动态镜头，构建立体空间与氛围。
- **动静结合**：以环境细节烘托情绪，静物与动作相辅相成。

**二、行文与标点**
- **感叹号优先**：旁白带情绪、决断或冲击时，必须用感叹号。
- **标点规范**：引号`""`仅用于对白，框内禁用`''`、`……`、`——`。严禁为强调而给词汇加引号。
- **段落精简**：每段≤2行。场景/视角切换必换行，动作与对话分行。

**三、节奏与旁白**
- **删解释留感知**：严禁解释性心理（如“他想”），只写可观察的动作、对话与环境反应。可保留生理感知（瞳孔收缩）或瞬间心声。
- **旁白极简**：战斗用短句（3–10字），氛围描写需具体可感。
- **跳跃叙事**：删除流水账，直接切换场景。

**四、对话与声纹**
- **高位者**：从容，用长句、反问、停顿，配合慢动作与沉稳声线。
- **低位者**：急促，用短句、感叹号，语速快而直白。
- **自然节奏**：严禁对话前后加解释；长句须被微动作打断（说—动—说）。

**五、视角与结构**
- **严格POV**：仅写主角所见所感，不泄露其未知信息。
- **设定严谨**：禁止二创环境设定。
- **节奏把控**：开篇200字设钩子，1500字一小高潮，结尾留悬念。

**六、沉浸感营造**
- **动作可视化**：写清动作的力度、速度、方向及引发的场景变化。
- **环境互动**：人物影响环境，环境反馈人物，空间转换自然。
- **情绪画面化**：用肢体、环境与感官细节代替直接情绪说明。

**七、技巧强化**
- **镜头语言**：运用推、拉、摇、移等手法。
- **感官叠加**：同一场景调动多感官。
- **句式控节奏**：紧张时短句，舒缓时长句。
- **细节聚焦**：关键处特写。

请按照以上文风要求进行重写，输出修改后的完整章节正文（不要包含任何解释性语言，直接输出正文）：
"""

# =============== 10. 章节目录微调 ===================
REFINE_DIRECTORY_PROMPT = """你是一名专业的小说主编和架构师。
用户希望微调 **{chapter_range}** 的大纲。为了确保剧情连贯，请结合以下全局背景信息进行修改。

【全局背景资料】：
1. **小说核心架构**：
{novel_architecture}

2. **当前剧情演进**（全局摘要）：
{global_summary}

【待修改章节 - 原始内容】：
{current_outline}

【用户的修改指令】：
{user_instruction}

【任务要求】：
1. **逻辑自洽**：修改后的剧情必须符合设定，且章节之间（如第N章到第N+1章）的衔接必须流畅。
2. **格式保持**：**绝对保持**原有的字段结构（章节编号/标题/定位/作用/简述等）。**不要合并章节**，保持原有的章节数量和编号不变。
3. **精准执行**：根据指令进行增删改，未提及的部分保持原样。

请输出修改后的**完整章节大纲段落**（直接输出内容，不要加```等标记）：
"""

# =============== 11. 角色变化检测与档案更新 ===================
DETECT_CHANGES_PROMPT = """
请分析以下小说章节文本，找出所有在剧情中**状态、能力、持有物品或人际关系发生实质性变化**的角色名字，以及新登场的重要角色。
请只返回名字列表，格式为JSON字符串数组，例如：["叶落", "穆先生", "夜灵"]。
如果没有任何角色发生重要变化，返回空数组 []。

【章节文本】：
{chapter_text}
"""

# 11.2 角色档案更新提示
UPDATE_PROFILE_PROMPT = """
你是一个严谨的小说角色档案管理员。请根据【当前章节】的剧情发展，更新该角色的【角色档案】。

【当前章节】：
{chapter_text}

【角色档案（旧）】：
{old_profile}

【任务要求】：
1. **增量更新**：仅根据本章发生的事件更新对应条目（如：获得新物品、受了伤、习得新技能、关系变化）。
2. **保持格式**：严格保持原有的树状图结构（物品/能力/状态/关系网/事件），不要更改标题。
3. **新角色处理**：如果旧档案只有模板，请根据章节内容填入初始信息。
4. **输出纯文本**：直接输出更新后的档案内容，不要包含 ```json 或其他解释性文字。

【标准格式参考】：
{char_name}：
├──物品：
│  ├──[物品名]
├──能力：
│  ├──[能力名]
├──状态：
│  ├──[当前状态]
├──主要角色间关系网：
│  ├──[关系描述]
├──触发或加深的事件：
│  └──[事件名]

请输出更新后的完整档案：
"""

# 11.3 伏笔分析提示
FORESHADOWING_ANALYSIS_PROMPT = """
你是一名拥有"上帝视角"的小说分析师。请仔细阅读【当前章节】，提取其中埋下的所有伏笔，并进行分类。

【已有伏笔记录】：
{existing_foreshadowing_records}

【当前章节文本】：
{chapter_text}

【分析要求】：
1. **区分长短线**：
   - **短线伏笔**：预计在未来3-10章内就会解决或爆发的冲突/悬念（如：反派的临时报复、即将到来的考核）。
   - **长线伏笔**：涉及世界观真相、主角身世、大后期BOSS、核心金手指进化等贯穿全文的线索。
2. **整合与发展**：
   - **避免重复**：检查当前章节是否延续了已有伏笔的发展，而不是创建全新伏笔
   - **发展已有伏笔**：如果当前章节推进了已有伏笔，应标注其进展状态
   - **新增伏笔**：仅记录当前章节真正引入的新伏笔
3. **格式规范**：
   - 必须严格按照下方格式输出。
   - 如果某类伏笔本章没有，请写"无"。

【输出格式】：
第{novel_number}章伏笔记录：
【短线伏笔】：
1. [对象/事件] ......
2. ......
【长线伏笔】：
1. [对象/事件] ......
2. ......
-------------------
"""

